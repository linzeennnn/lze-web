function uploadFolder(){let e;ifroot();const t=document.getElementById("uploadfolder"),n=t.files;if(0===n.length)return;loading(1),showupload(0);const o=1048576,a=n.length;let l=0,d=0,i=0;for(let e of n)l+=Math.ceil(e.size/o);const r=document.getElementById("percent"),s=()=>{const e=d/l*100;document.getElementById("bar").style.width=e+"%",r.innerHTML=parseInt(e)+"%"},p=(t,l)=>{let r=0;const p=r=>{const f=Math.min(r+o,t.size),c=t.slice(r,f),u=t.webkitRelativePath;0===l&&0===r&&(e=n[0].webkitRelativePath.split("/")[0]);const h=new FormData;h.append("file",c,t.name),h.append("relativePath",u),h.append("start",r),h.append("total",t.size),0===l&&0===r&&h.append("1st",!0),fetch(`${protocol}//${ip}/code/Documents/upload_folder.php`,{method:"POST",body:h}).then(e=>e.text()).then(n=>{d++,s(),f<t.size?p(f):(i++,i===a&&(movefolder(e,nowpath),loading(0)))}).catch(e=>{console.error("上传失败:",e)})};p(r)};for(let e=0;e<n.length;e++)p(n[e],e);t.value=""}function movefolder(e,t){fetch(`${protocol}//${ip}/code/Documents/move_folder.php`,{method:"POST",body:new URLSearchParams({name:e,path:t})}).then(e=>e.text()).then(e=>{notify(e),loadFolder(removeslash(t))}).catch(e=>{notify(e)})}function selfile(){function e(d){if(d>=o)loading(0);else{var i=t[d],r=l[d]*n,s=Math.min(r+n,i.size),p=i.slice(r,s),f=new FormData;f.append("file",p),f.append("fileName",i.name),f.append("totalChunks",a[d]),f.append("currentChunk",l[d]),f.append("nowpath",nowpath);var c=new XMLHttpRequest;c.open("POST",`${protocol}//${ip}/server/doc/upload.cgi`,!0),xmltoken(c),c.upload.onprogress=function(e){if(e.lengthComputable){var t=(l[d]+e.loaded/e.total)/a[d]*100,n=document.getElementById("percent");document.getElementById("bar").style.width=t+"%",n.innerHTML=parseInt(t)+"%"}},c.onload=function(){xmlnologin(c),200===c.status&&(l[d]++,l[d]<a[d]?e(d):(e(d+1),notify(`文件 ${i.name} 上传成功`),loadFolder(removeslash(nowpath))))},c.send(f)}}ifroot();var t=fileInput.files;if(0!==t.length){showupload(0);var n=1048576,o=t.length,a=Array(o).fill(0),l=Array(o).fill(0);for(let e=0;e<o;e++){if(0===t[e].size)return void notify(`${t[e].name} 是空文件，上传失败`);a[e]=Math.ceil(t[e].size/n)}loading(1),e(0)}else notify("请先选择文件")}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="1"}function handleDragLeave(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity=""}function handleDrop(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="";const t=e.dataTransfer,n=(t.files,t.items);for(let e=0;e<n.length;e++){const t=n[e];if("file"===t.kind&&t.webkitGetAsEntry().isFile){const e=t.getAsFile();if(e){const t=new DataTransfer;t.items.add(e),fileInput.files=t.files,selfile()}}else notify("文件夹自己去手动上传")}}const folderinput=document.getElementById("uploadfolder"),fileInput=document.getElementById("uploadfile"),uploadarea=document.getElementById("upload-area"),filelist=document.getElementById("fileListContainer");document.addEventListener("dragover",handleDragOver),document.addEventListener("dragleave",handleDragLeave),document.addEventListener("drop",handleDrop),filelist.addEventListener("dragover",handleDragOver),filelist.addEventListener("dragleave",handleDragLeave),filelist.addEventListener("drop",handleDrop);