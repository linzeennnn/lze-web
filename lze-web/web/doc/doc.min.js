function optionbar(e){const t=document.getElementById("option-bar"),n=document.getElementById("openbar");switch(e){case 0:allmove(e),optionstatus=0,n.style.display="block",t.style.left="",setTimeout(()=>{t.style.display="none"},1e3);break;case 1:allmove(e),optionstatus=1,t.style.display="",setTimeout(()=>{n.style.display="none",t.style.left="0"},10)}}function allmove(e){const t=document.querySelectorAll(".main");switch(e){case 1:t.forEach(function(e,t){e&&(e.style.marginLeft="")});break;case 0:t.forEach(function(e,t){e.style.marginLeft="0"})}}function handleScroll(){var e=window.scrollY||document.documentElement.scrollTop;e>100?(document.getElementById("top-btn").style.bottom="90px",document.querySelector(".backbtn").style.left="1%",document.getElementById("top-bar").style.boxShadow="none",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter="none",document.getElementById("top-bar").style.webkitBackdropFilter="none"):(document.getElementById("top-btn").style.bottom="",document.querySelector(".backbtn").style.left="5%",document.getElementById("top-bar").style.boxShadow="",document.getElementById("top-bar").style.top="77px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter="",document.getElementById("top-bar").style.webkitBackdropFilter="")}function comin(){access(),theme(mode,"green"),loadFolder(),document.querySelector(".backbtn").style.left="5%",document.getElementById("fileListContainer").style.opacity="1",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.getElementById("top-bar").style.top="77px",loginstatus()}function goBack(){window.location.replace(`../../index.html#${ip}`)}function loading(e){const t=document.getElementById("uploadfile"),n=document.getElementById("uploadfolder"),o=document.getElementById("loading"),l=document.getElementById("rotate-box"),a=(document.getElementById("load-text"),document.getElementById("upButton")),d=document.getElementById("currentPath"),s=document.getElementById("progress");switch(e){case 1:if(0===t.files.length&&0===n.files.length)return void notify("请先选择一个文件进行上传");d.style.display="none",a.style.display="none",s.style.display="block",o.style.display="block",l.style.display="block";break;case 0:d.style.display="",a.style.display="",s.style.display="none",o.style.display="none",l.style.display="none"}}function pathlen(e,t){const n=e.offsetWidth,o=document.createElement("span");o.style.visibility="hidden",o.style.position="absolute",o.style.font=window.getComputedStyle(e).font,o.innerText="字",document.body.appendChild(o);const l=o.offsetWidth;document.body.removeChild(o);const a=Math.floor(n/l);let d=t;t.length>a&&"currentPath"===e.id?d="..."+t.slice(-a):t.length>a&&(d=t.slice(0,a)+"..."),e.innerText=d}function loadFolder(e=""){pageloading(1),selectedarray.length=0,fetch(`${protocol}//${ip}/server/doc/list.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder:e})}).then(e=>(fetchnologin(e),e.json())).then(e=>{const t=document.getElementById("fileList");t.innerHTML="";const n=document.getElementById("currentPath");fullPath=(e.currentFolder?e.currentFolder:"")+"/",pathlen(n,fullPath),n.title=fullPath;const o=e.file_list[0];for(const[n,l]of Object.entries(o)){if("file"===l||"link_file"===l){const o=document.createElement("li"),l=document.createElement("div");l.className="edit li-btn",l.title="重命名",l.addEventListener("click",function(){event.stopPropagation(),rename(0,o,1)});const a=document.createElement("div");a.className="save li-btn",a.addEventListener("click",function(){event.stopPropagation(),rename(1,o)}),o.className="files",o.classList.add("file");const d=document.createElement("span"),s=document.createElement("input");s.classList.add("file-tit");protocol,ip,e.currentFolder&&e.currentFolder,document.getElementById("fileListContainer");d.textContent=n,d.className="fileLink",d.title=`预览${n}`,o.addEventListener("click",function(){select(o,1)}),d.addEventListener("click",function(){if(event.stopPropagation(),event.target.isContentEditable)return;let e;nowpath=fullPath;let t=`${protocol}//${ip}/file/Documents/`;e="/"===nowpath?t+n:t+nowpath+n,window.location.href=e}),o.appendChild(s),o.appendChild(d),o.appendChild(l),o.appendChild(a);const i=document.createElement("div");i.className="downloadLink",i.classList.add("down-btn"),i.title=`下载${n}`,i.textContent=`下载 ${n}`,i.addEventListener("click",()=>{event.stopPropagation(),down_file(e.currentFolder,n)}),o.appendChild(i),t.appendChild(o)}if("folder"===l||"link_dir"===l){const o=document.createElement("li"),l=document.createElement("div"),a=document.createElement("div");a.classList.add("down-btn"),a.title=`下载${n}`,a.addEventListener("click",function(){event.stopPropagation(),downfolder(o)}),l.className="edit li-btn",l.title="重命名",l.addEventListener("click",function(){event.stopPropagation(),rename(0,o,2)});const d=document.createElement("div");d.className="save li-btn",d.addEventListener("click",function(){event.stopPropagation(),rename(1,o)}),o.className="files",o.classList.add("folder");const s=document.createElement("span"),i=document.createElement("input");i.classList.add("file-tit"),s.textContent=n,s.className="folderLink",s.title="进入"+n,o.addEventListener("click",function(){select(o,2)}),s.addEventListener("click",function(){event.stopPropagation(),event.target.isContentEditable||loadFolder(e.currentFolder?e.currentFolder+"/"+n:n)}),o.appendChild(i),o.appendChild(s),o.appendChild(a),o.appendChild(l),o.appendChild(d),t.appendChild(o)}}pageloading(0);const l=document.getElementById("upButton");e.currentFolder&&""!==e.currentFolder?(l.style.display="block",l.dataset.parentFolder=e.parentFolder,l.style.pointerEvents="auto"):l.style.pointerEvents="none"})}function goUp(){const e=document.getElementById("upButton"),t=e.dataset.parentFolder;loadFolder(t)}function ifroot(){nowpath="/"==fullPath?"":fullPath}function keynewfolder(e){"Enter"===e.key&&newfolder(2)}function newfolder(e){const t=document.getElementById("path-bar"),n=document.getElementById("folder-name-bar"),o=document.getElementById("comfirm"),l=document.getElementById("cancel-folder"),a=document.getElementById("upButton"),d=document.getElementById("add-folder");let s=n.value;switch(e){case 1:if(0!=editmode)return void notify("请保存正在编辑内容");editmode=1,t.style.display="none",n.style.display="block",o.style.display="block",l.style.display="block",a.style.display="none",d.style.display="none",document.addEventListener("keydown",keynewfolder);break;case 0:t.style.display="",n.style.display="",o.style.display="",l.style.display="",a.style.display="",d.style.display="",editmode=0,document.removeEventListener("keydown",keynewfolder);break;case 2:ifroot(),pageloading(1),""===s&&(s="new_folder"),fetch(`${protocol}//${ip}/server/doc/new_folder.cgi`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({folderName:s,nowpath:nowpath})}).then(e=>e.text()).then(e=>{loadFolder(removeslash(nowpath)),n.value="",editmode=0,document.removeEventListener("keydown",keynewfolder),notify("新建:"+s)}).catch(e=>{console.error("Error:",e)}),newfolder(0)}}function del(){if(access(),confirm("确定要删除所选文件吗")){ifroot(),pageloading(1);const e=JSON.stringify(selectedarray),t={dellist:e};fetch(`${protocol}//${ip}/server/doc/del.cgi`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{if(401===e.status)throw new Error("未授权访问");return e.text()}).then(e=>{loadFolder(removeslash(nowpath)),notify("已删除"),pastebtn.style.display="none",copyarray.length=0}).catch(e=>{console.error("错误:",e)})}}function down_file(e,t){e=e+"/"+t,window.location.href=`${protocol}//${ip}/server/doc/download_file.cgi?file_path=${e}`,notify("开始下载")}function copy(e){if(copyarray.length=0,0==selectedarray.length)return notify("请选择文件"),void(pastebtn.style.display="none");switch(e){case 1:pastestatus=1;break;case 0:pastestatus=0}copyarray=selectedarray.slice(),pastebtn.style.display="block"}function paste(){ifroot(),copylist=JSON.stringify(copyarray);const e={copylist:copylist,nowpath:nowpath};switch(pastestatus){case 1:access(),pageloading(1),fetch(`${protocol}//${ip}/server/doc/copy.cgi`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>{if(401===e.status)throw new Error("未授权访问");return e.text()}).then(e=>{loadFolder(removeslash(nowpath)),notify("已复制"),pastebtn.style.display="none",copyarray.length=0}).catch(e=>{console.error("错误:",e)});break;case 0:access(),pageloading(1),fetch(`${protocol}//${ip}/server/doc/move.cgi`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>{if(401===e.status)throw new Error("未授权访问");return e.text()}).then(e=>{loadFolder(removeslash(nowpath)),notify("已移动"),pastebtn.style.display="none",copyarray.length=0,console.log(e)}).catch(e=>{console.error("错误:",e)})}}function select(e,t){switch(t){case 1:filesname=e.querySelector(".fileLink");break;case 2:filesname=e.querySelector(".folderLink")}selectedpath=fullPath+filesname.innerText,e.classList.contains("selected")?(notify("取消选择"),e.classList.remove("selected"),index=selectedarray.indexOf(selectedpath),selectedarray.splice(index,1)):(selectcount=selectedarray.length+1,notify("已选择"+selectcount+"个文件"),e.classList.add("selected"),selectedarray.push(selectedpath))}function rename(e,t,n,o){let l,a,d;const s=t.querySelector(".edit"),i=t.querySelector(".save"),c=t.querySelector(".file-tit");switch(n){case 1:d=t.querySelector(".fileLink");break;case 2:d=t.querySelector(".folderLink")}switch(e){case 0:if(0!=editmode)return void notify("请保存正在编辑内容");editmode=1,s.style.display="none",i.style.display="block",d.style.display="none",c.style.display="block",c.contentEditable="true",c.value=d.innerText,d.setAttribute("contenteditable","true"),oldname=d.innerText;break;case 1:ifroot(),newname=c.value,a=nowpath+oldname,l=nowpath+newname,fetch(`${protocol}//${ip}/server/doc/rename.cgi`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({oldpath:a,newpath:l})}).then(e=>e.text()).then(e=>{loadFolder(removeslash(nowpath)),editmode=0,notify("修改成功")}).catch(e=>{console.log(e),notify(data)})}}function removeslash(e){return e.endsWith("/")?e.slice(0,-1):e}function showupload(e){const t=document.getElementById("upload-page");switch(e){case 0:t.style.opacity="0",setTimeout(()=>{t.style.display=""},500);break;case 1:t.style.display="flex",setTimeout(()=>{t.style.opacity="1"},10)}}function clickable(e){switch(e){case 0:document.body.style.pointerEvents="none";break;case 1:document.body.style.pointerEvents="auto"}}let uploadpath,fullPath,pastestatus,nowpath="/",editmode=0;window.addEventListener("scroll",handleScroll),window.onload=comin;let copyarray=[];const pastebtn=document.getElementById("paste");let copylist,filesname,selectedpath,index,selectcount,oldname,newname,selectedarray=[];