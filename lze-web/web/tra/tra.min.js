function optionbar(e){const t=document.getElementById("option-bar"),n=document.getElementById("openbar");switch(e){case 0:allmove(e),optionstatus=0,n.style.display="block",t.style.left="",setTimeout(()=>{t.style.display="none"},1e3);break;case 1:allmove(e),optionstatus=1,t.style.display="",setTimeout(()=>{n.style.display="none",t.style.left="0"},10)}}function allmove(e){const t=document.querySelectorAll(".main");switch(e){case 1:t.forEach(function(e,t){e&&(e.style.marginLeft="")});break;case 0:t.forEach(function(e,t){e.style.marginLeft="0"})}}function handleScroll(){var e=window.scrollY||document.documentElement.scrollTop;e>100?(document.getElementById("top-btn").style.bottom="90px",document.querySelector(".backbtn").style.left="1%",document.getElementById("top-bar").style.boxShadow="none",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter="none",document.getElementById("top-bar").style.webkitBackdropFilter="none"):(document.getElementById("top-btn").style.bottom="",document.querySelector(".backbtn").style.left="5%",document.getElementById("top-bar").style.boxShadow="",document.getElementById("top-bar").style.top="77px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter="",document.getElementById("top-bar").style.webkitBackdropFilter="")}function comin(){access(),loadFolder(),theme(mode,"orange"),document.querySelector(".backbtn").style.left="5%",document.getElementById("fileListContainer").style.opacity="1",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.getElementById("top-bar").style.top="77px",loginstatus()}function goBack(){window.location.replace(`../../index.html#${ip}`)}function pathlen(e,t){const n=e.offsetWidth,o=document.createElement("span");o.style.visibility="hidden",o.style.position="absolute",o.style.font=window.getComputedStyle(e).font,o.innerText="字",document.body.appendChild(o);const l=o.offsetWidth;document.body.removeChild(o);const c=Math.floor(n/l);let r=t;t.length>c&&"currentPath"===e.id?r="..."+t.slice(-c):t.length>c&&(r=t.slice(0,c)+"..."),e.innerText=r}async function loadFolder(e=""){selectedarray.length=0;try{const t=await fetch(`${protocol}//${ip}/server/tra/list.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder:e})});fetchnologin(t);const n=await t.json(),o=document.getElementById("fileList");o.innerHTML="";const l=document.getElementById("currentPath");fullPath=(n.currentFolder?n.currentFolder:"")+"/",pathlen(l,fullPath),l.title=fullPath,n.folders.forEach(e=>{const t=document.createElement("li");t.className="files";const l=document.createElement("span");l.textContent=e,l.classList.add("folderLink","filename"),t.addEventListener("click",function(){select(t,2)}),l.addEventListener("click",function(t){t.stopPropagation(),t.target.isContentEditable||loadFolder(n.currentFolder?n.currentFolder+"/"+e:e)}),t.appendChild(l),o.appendChild(t)}),n.files.forEach(e=>{const t=document.createElement("li");t.className="files";const l=document.createElement("span");protocol,ip,n.currentFolder&&n.currentFolder,document.getElementById("fileListContainer");l.textContent=e,l.classList.add("fileLink","filename"),l.title=`预览${e}`,t.addEventListener("click",function(){select(t,1)}),l.addEventListener("click",function(t){if(t.stopPropagation(),t.target.isContentEditable)return;let n;nowpath=fullPath;let o=`${protocol}//${ip}/file/trash/`;n="/"===nowpath?o+e:o+nowpath+e,window.location.href=n}),t.appendChild(l),o.appendChild(t)});const c=document.getElementById("upButton");n.currentFolder&&""!==n.currentFolder?(c.style.display="block",c.dataset.parentFolder=n.parentFolder,c.style.pointerEvents="auto"):c.style.pointerEvents="none",getpath()}catch(e){console.error("Error loading folder:",e)}}async function getpath(){const e=await fetch(`${protocol}//${ip}/file/data/deleted_metadata.json`,{method:"GET",cache:"no-cache"}),t=await e.json(),n=Object.keys(t),o=document.querySelectorAll(".filename");o.forEach(e=>{if(n.includes(e.innerText)){const n=document.createElement("span");n.className="oripath",n.innerText=t[e.innerText].replace("../../file/Documents","")||"/",e.insertAdjacentElement("afterend",n)}else{const t=document.createElement("span");t.className="oripath",t.innerText="/"+e.innerText,e.insertAdjacentElement("afterend",t)}})}function goUp(){const e=document.getElementById("upButton"),t=e.dataset.parentFolder;loadFolder(t)}function ifroot(){nowpath="/"==fullPath?"":fullPath}function recover(){access(),ifroot(),fetch(`${protocol}//${ip}/server/tra/recover.cgi`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify(pathsMap)}).then(e=>{if(401===e.status)throw new Error("未授权访问")}).then(e=>{selectedarray.length,loadFolder(removeslash(nowpath)),notify("已恢复"),selectedarray.length=0}).catch(e=>{console.error("错误:",e)})}function select(e,t){let n;switch(t){case 1:n=e.querySelector(".fileLink");break;case 2:n=e.querySelector(".folderLink")}selectedpath=fullPath+n.innerText,e.classList.contains("selected")?(notify("取消选择"),e.classList.remove("selected"),index=selectedarray.indexOf(selectedpath),selectedarray.splice(index,1),recover_list.splice(recover_list.indexOf(selectedpath),1)):(selectcount=selectedarray.length+1,notify("已选择"+selectcount+"个文件"),e.classList.add("selected"),selectedarray.push(selectedpath),recover_list.push(selectedpath))}function removeslash(e){return e.endsWith("/")?e.slice(0,-1):e}function cleanall(){confirm("确定清空回收站吗")&&(ifroot(),fetch(`${protocol}//${ip}/server/tra/del.cgi`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token}}).then(e=>e.text()).then(e=>{loadFolder(removeslash(nowpath)),notify("已清空")}).catch(e=>console.error("Error:",e)))}let uploadpath,fullPath,filesname,selectedpath,nowpath="/",editmode=0;window.addEventListener("scroll",handleScroll),window.onload=comin;let index,selectcount,recoverpath,selectedarray=[],recover_list=[],pathsMap={recover_list:recover_list};