function optionbar(e){const t=document.getElementById("option-bar"),o=document.getElementById("openbar");switch(e){case 0:allmove(e),optionstatus=0,o.style.display="block",t.style.left="",setTimeout(()=>{t.style.display="none"},1e3);break;case 1:allmove(e),optionstatus=1,t.style.display="",setTimeout(()=>{o.style.display="none",t.style.left="0"},10)}}function allmove(e){const t=document.querySelectorAll(".main");switch(e){case 1:t.forEach(function(e,t){e&&(e.style.marginLeft="")});break;case 0:t.forEach(function(e,t){e.style.marginLeft="0"})}}function handleScroll(){var e=window.scrollY||document.documentElement.scrollTop;e>100?(document.getElementById("top-btn").style.bottom="15%",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("top-bar").style.boxShadow="none",document.querySelector(".backbtn").style.left="1%",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter="none",document.getElementById("top-bar").style.webkitBackdropFilter="none"):(document.getElementById("top-btn").style.bottom="",document.getElementById("top-bar").style.top="100px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("top-bar").style.boxShadow="",document.querySelector(".backbtn").style.left="5%",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter="",document.getElementById("top-bar").style.webkitBackdropFilter="")}function comin(){creatnote(),theme(mode,"pink"),document.getElementById("allnote").style.right="0",document.getElementById("top-bar").style.top="100px",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.querySelector(".backbtn").style.left="5%",loginstatus()}function goBack(){window.location.replace(`../../index.html#${ip}`)}function reloadPage(){location.reload()}async function readfile(e){const t=await fetch(e,{cache:"no-store"}),o=await t.text();return o}async function getnote(){(new Date).getTime();const e=await fetch(`${protocol}//${ip}/server/not/list.cgi`,fetchtoken()),t=await e.json();return fetchnologin(e),t}async function creatnote(){pageloading(1);const e=document.getElementById("allnote");try{const t=await getnote();for(const o of Object.values(t)){const t=o.replace(/\.[^/.]+$/,""),n=document.createElement("div");n.className="note";const l=document.createElement("input");l.className="title",l.value=t,l.title=t,l.disabled=!0,n.appendChild(l);const a=document.createElement("code");a.className="text",a.style.display="none",n.appendChild(a);const c=document.createElement("div");c.className="edit",c.title="编辑",c.style.display="none",c.addEventListener("click",()=>editnote(n,1)),n.appendChild(c);const d=document.createElement("div");d.className="save",d.addEventListener("click",()=>editnote(n,0,`${o}`)),d.style.display="none",n.appendChild(d);const i=document.createElement("div");i.className="copy",i.title="复制",i.style.display="none",n.appendChild(i);const r=document.createElement("div");r.className="expend",r.title="展开",r.addEventListener("click",()=>loadtext(n,o)),n.appendChild(r);const s=document.createElement("div");s.className="loading",n.appendChild(s),s.style.display="none";const y=document.createElement("div");y.className="close",y.title="合上",y.style.display="none",y.addEventListener("click",()=>notedisplay(n,0)),n.a,n.appendChild(y);const p=document.createElement("div");p.className="del",p.addEventListener("click",function(){0==editstatus?confirm("确定要删除这个便签吗？")&&delnote(`${o}`):notify("请先保存正在编辑的内容")}),n.appendChild(p),e.appendChild(n)}pageloading(0)}catch(e){console.error("Error reading files:",e)}}function notedisplay(e,t){const o=e.querySelector(".text"),n=e.querySelector(".expend"),l=e.querySelector(".close"),a=e.querySelector(".edit"),c=e.querySelector(".copy");1==t?(a.style.display="block",o.style.display="block",n.style.display="none",l.style.display="block",c.style.display="block"):0==t&&(a.style.display="none",o.style.display="none",n.style.display="block",l.style.display="none",c.style.display="none")}function replaceNbspWithSpace(e){return e.replace(/\u00A0/g," ")}function copytext(e,t){const o=e.querySelector(".copy"),n=replaceNbspWithSpace(t);if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(n).then(()=>{o.style.backgroundImage="url(../../icon/yes_pink.svg)",notify("成功复制"),setTimeout(()=>{o.style.backgroundImage="url(../../icon/copy_pink.svg)"},2e3)}).catch(e=>{console.error("Failed to copy text to clipboard: ",e)});else{const e=document.createElement("textarea");e.value=n,document.body.appendChild(e),e.select();try{document.execCommand("copy"),o.style.backgroundImage="url(../../icon/yes_pink.svg)",notify("成功复制"),setTimeout(()=>{o.style.backgroundImage="url(../../icon/copy_pink.svg)"},2e3)}catch(e){console.error("Failed to copy text to clipboard: ",e)}document.body.removeChild(e)}}function delnote(e,t){pageloading(1),fetch(`${protocol}//${ip}/server/not/del.cgi`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify({fileName:e})}).then(e=>{e.ok?0!=t&&(reloadnote(),notify("已删除")):console.error(`Error deleting note: ${e.statusText}`)}).catch(e=>{console.error(`Error deleting note: ${e.message}`)})}async function addnote(e,t,o){if(e.value.includes("%")||e.value.includes("#"))return void notify("标题包含非法字符(#或%)");""==e.value&&(e.value="new_note"),pageloading(1);const n={newTitle:e.value,newContent:t.innerText};try{console.log(n);const l=await fetch(`${protocol}//${ip}/server/not/${o}`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify(n)});fetchnologin(l),401!==l.status&&(reloadnote(),e.value="",t.innerText="",notify("保存成功"))}catch(e){console.error("Error adding new note:",e)}}function editnote(e,t,o){const n=e.querySelector(".title"),l=e.querySelector(".text"),a=e.querySelector(".save"),c=e.querySelector(".edit");1==t?0!=editstatus?notify("请先保存正在编辑的内容"):(editstatus=1,oldtitle=n.value,n.disabled=!1,n.contentEditable="true",l.contentEditable="true",l.style.borderStyle="none",l.style.borderRadius="1em",n.style.boxShadow="var(--inshadow)",l.style.boxShadow="var(--inshadow)",c.style.display="none",a.style.display="block"):0==t&&(n.value===oldtitle?addnote(n,l,"save.cgi"):(delnote(o,0),addnote(n,l,"add.cgi")),editstatus=0)}async function loadtext(e,t){const o=e.querySelector(".text"),n=e.querySelector(".expend"),l=e.querySelector(".loading"),a=e.querySelector(".copy");if(""!==o.innerHTML.trim())notedisplay(e,1);else{n.style.display="none",l.style.display="block";const t=e.querySelector(".title").value,c=`${protocol}//${ip}/file/Note/${t}.txt`;try{const t=await readfile(c);o.innerHTML=hljs.highlightAuto(t).value.replace(/\n/g,"<br>"),notedisplay(e,1),a.addEventListener("click",()=>copytext(e,t))}catch(e){console.error("Error loading text:",e)}finally{l.style.display="none"}}}function reloadnote(){document.getElementById("allnote").innerHTML="",creatnote()}function selfile(){var e=document.getElementsByTagName("input")[0].files;if(0!==e.length){document.getElementById("word-bar").style.display="none",document.getElementById("progress").style.display="block";for(var t=new FormData,o=0;o<e.length;o++){var n=e[o];if(n.size>2097152)return void notify("文件不能超过2MB");if(!n.type.match(/text.*/)&&".txt"!==n.name.slice(-4))return void notify("不支持类型");if(".txt"!==n.name.slice(-4)){var l=n.name+".txt",a=new Blob([n],{type:n.type});a=new File([a],l,{type:n.type}),t.append("pic[]",a)}else t.append("pic[]",n)}var c=new XMLHttpRequest;c.open("POST",`${protocol}//${ip}/server/not/upload.cgi`,!0),xmltoken(c),c.upload.onprogress=function(e){if(e.lengthComputable){var t=100*e.loaded/e.total,o=document.getElementById("percent");document.getElementById("bar").style.width=t+"%",o.innerHTML=parseInt(t)+"%"}},c.onload=function(){c.readyState===XMLHttpRequest.DONE&&(xmlnologin(c),401!=c.status&&(notify("添加成功"),reloadnote(),document.getElementById("word-bar").style.display="block",document.getElementById("progress").style.display="none"))},c.send(t)}else notify("请先选择文件")}const titbar=document.getElementById("tit-bar"),wordbar=document.getElementById("word-bar");let oldtitle,editstatus=0;window.addEventListener("scroll",handleScroll),window.onload=comin,document.addEventListener("paste",function(e){e.preventDefault();const t=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)});