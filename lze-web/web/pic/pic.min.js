function optionbar(e){const t=document.getElementById("option-bar"),n=document.getElementById("openbar");switch(e){case 0:allmove(e),optionstatus=0,n.style.display="block",t.style.left="",setTimeout(()=>{t.style.display="none"},1e3);break;case 1:allmove(e),optionstatus=1,t.style.display="",setTimeout(()=>{n.style.display="none",t.style.left="0"},10)}}function allmove(e){const t=document.querySelectorAll(".main");switch(e){case 1:t.forEach(function(e,t){e&&(e.style.marginLeft="")});break;case 0:t.forEach(function(e,t){e.style.marginLeft="0"})}}function handleScroll(){var e=window.scrollY||document.documentElement.scrollTop;e>100?(document.getElementById("top-btn").style.bottom="200px",document.querySelector(".backbtn").style.left="1%",document.getElementById("top-bar").style.boxShadow="none",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter="none",document.getElementById("top-bar").style.webkitBackdropFilter="none"):(document.getElementById("top-btn").style.bottom="",document.querySelector(".backbtn").style.left="5%",document.getElementById("top-bar").style.boxShadow="",document.getElementById("top-bar").style.top="77px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter="",document.getElementById("top-bar").style.webkitBackdropFilter="")}function comin(){access(),loadFolder(),theme(mode,"blue"),document.querySelector(".backbtn").style.left="5%",document.getElementById("fileListContainer").style.opacity="1",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.getElementById("top-bar").style.top="77px",loginstatus()}function goBack(){window.location.replace(`../../index.html#${ip}`)}function loading(e){const t=document.getElementById("uploadfile"),n=document.getElementById("uploadfolder"),o=document.getElementById("loading"),l=document.getElementById("rotate-box"),a=(document.getElementById("load-text"),document.getElementById("upButton")),i=document.getElementById("currentPath"),c=document.getElementById("progress");switch(e){case 1:if(0===t.files.length&&0===n.files.length)return void notify("请先选择一个文件进行上传");i.style.display="none",a.style.display="none",c.style.display="block",o.style.display="block",l.style.display="block";break;case 0:i.style.display="",a.style.display="",c.style.display="none",o.style.display="none",l.style.display="none"}}function pathlen(e,t){const n=e.offsetWidth,o=document.createElement("span");o.style.visibility="hidden",o.style.position="absolute",o.style.font=window.getComputedStyle(e).font,o.innerText="字",document.body.appendChild(o);const l=o.offsetWidth;document.body.removeChild(o);const a=Math.floor(n/l);let i=t;t.length>a&&"currentPath"===e.id?i="..."+t.slice(-a):t.length>a&&(i=t.slice(0,a)+"..."),e.innerText=i}async function loadFolder(e=""){pageloading(1),curpage=1;try{const t=await fetch(`${protocol}//${ip}/server/pic/list.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder:e})});fetchnologin(t);const n=await t.json();let o=0,l=0;phonum=1,vidnum=1;const a=document.getElementById("oth-list"),i=document.getElementById("pic-box");i.innerHTML="",a.innerHTML="";const c=document.getElementById("currentPath");fullPath=(n.currentFolder?n.currentFolder:"")+"/",pathlen(c,fullPath),c.title=fullPath;const d=n.file_list[0];for(const[t,c]of Object.entries(d)){if("file"===c||"link_file"===c){const n=document.createElement("div"),a=document.createElement("div");let c;a.classList.add("pic"),n.classList.add("load-loop"),a.addEventListener("click",function(){openpic(1,e+"/"+t)}),1==isvideo(t)?(a.classList.add("video"),c=document.createElement("video"),l%9==0&&0!=l&&vidnum++,a.classList.add(`vid-page${vidnum}`),l++):(a.classList.add("photo"),c=document.createElement("img"),o%9==0&&0!=o&&phonum++,a.classList.add(`pho-page${phonum}`),o++),c.setAttribute("loading","lazy"),c.draggable=!1,a.title="查看"+t,c.src=`${protocol}//${ip}/file/Pictures/${e}/${t}`,a.append(n),a.append(c),i.appendChild(a),c.onload=function(){n.style.display="none"},c.addEventListener("loadeddata",function(){n.style.display="none"})}if("folder"===c||"link_dir"===c){const e=document.createElement("div");e.classList.add("folder"),e.innerText=t,e.title=t,e.addEventListener("click",function(e){e.stopPropagation(),e.target.isContentEditable||loadFolder(n.currentFolder?n.currentFolder+"/"+t:t)}),a.appendChild(e)}}pageloading(0);const s=document.getElementById("upButton");n.currentFolder&&""!==n.currentFolder?(s.style.display="block",s.dataset.parentFolder=n.parentFolder,s.style.pointerEvents="auto"):s.style.pointerEvents="none",pagenum=phonum,showpic("pho")}catch(e){console.error("Error loading folder:",e),pageloading(0)}}function goUp(){const e=document.getElementById("upButton"),t=e.dataset.parentFolder;loadFolder(t)}function ifroot(){nowpath="/"==fullPath?"":fullPath}function removeslash(e){return e.endsWith("/")?e.slice(0,-1):e}function clickable(e){switch(e){case 0:document.body.style.pointerEvents="none";break;case 1:document.body.style.pointerEvents="auto"}}function showoth(e){const t=document.getElementById("oth-list");"flex"==t.style.display||1==e?t.style.display="none":t.style.display="flex"}function isvideo(e){const t=[".mp4",".avi",".mov",".wmv",".mkv",".ts",".webm",".flv",".m4v",".3gp",".mpeg",".rmvb",".vob"],n=e.slice(2+(e.lastIndexOf(".")-1>>>0)).toLowerCase();return t.includes(`.${n}`)?1:0}function displaypage(e,t,n){document.querySelectorAll(`.${n}-page${t}`).forEach(e=>{e.style.display="none"}),document.querySelectorAll(`.${n}-page${e}`).forEach(e=>{e.style.display="flex"}),0==t&&pagenumdis(curpage,pagenum)}function switchpage(e){switch(e){case 1:curpage<pagenum?(displaypage(curpage+1,curpage,pagetype),curpage++):notify("已是尾页");break;case 0:curpage>1?(displaypage(curpage-1,curpage,pagetype),curpage--):notify("已是首页")}pagenumdis(curpage,pagenum)}function showpic(e){document.querySelectorAll(".photo"),document.querySelectorAll(".video");switch(e){case"pho":pagenum=phonum,document.querySelectorAll(".video").forEach(e=>{e.style.display="none"});break;case"vid":pagenum=vidnum,document.querySelectorAll(".photo").forEach(e=>{e.style.display="none"})}curpage=1,pagetype=e,displaypage(curpage,0,e)}function pagenumdis(e,t){pagedis.innerText=e+"页/"+t+"页"}function openpic(e,t){let n;switch(e){case 1:picpage.style.display="flex","pho"==pagetype?n=document.createElement("img"):(n=document.createElement("video"),n.controls=!0,n.autoplay=!0),n.id="page-pic",n.draggable=!1,n.src=`${protocol}//${ip}/file/Pictures/${t}`,bigpic.appendChild(n),picmap="pho"==pagetype?Array.from(document.querySelectorAll("img")).filter(e=>e.offsetWidth>0&&e.offsetHeight>0).map(e=>e.src):Array.from(document.querySelectorAll("video")).filter(e=>e.offsetWidth>0&&e.offsetHeight>0).map(e=>e.src);break;case 0:bigpic.removeChild(document.getElementById("page-pic")),picpage.style.display="none"}}function switchpic(e){let t=document.getElementById("page-pic").src;const n=picmap.indexOf(t);switch(e){case 1:t=n<picmap.length-1?picmap[n+1]:picmap[0];break;case 0:t=n>0?picmap[n-1]:picmap[picmap.length-1]}document.getElementById("page-pic").src=t}function selfile(){function e(i){if(i>=o)loading(0);else{var c=t[i],d=a[i]*n,s=Math.min(d+n,c.size),p=c.slice(d,s),r=new FormData;r.append("file",p),r.append("fileName",c.name),r.append("totalChunks",l[i]),r.append("currentChunk",a[i]),r.append("nowpath",nowpath);var u=new XMLHttpRequest;u.open("POST",`${protocol}//${ip}/server/pic/upload.cgi`,!0),xmltoken(u),u.upload.onprogress=function(e){if(e.lengthComputable){var t=(a[i]+e.loaded/e.total)/l[i]*100,n=document.getElementById("percent");document.getElementById("bar").style.width=t+"%",n.innerHTML=parseInt(t)+"%"}},u.onload=function(){xmlnologin(u),200===u.status&&(a[i]++,a[i]<l[i]?e(i):(e(i+1),notify(`文件 ${c.name} 上传成功`),uploadpath=u.responseText,loadFolder(removeslash(nowpath)),desktopnot("新文件",`新上传文件: ${c.name}`,uploadpath)))},u.send(r)}}ifroot();var t=fileInput.files;if(0!==t.length){var n=20971520,o=t.length,l=Array(o).fill(0),a=Array(o).fill(0);for(let e=0;e<o;e++){if(0===t[e].size)return void notify(`${t[e].name} 是空文件，上传失败`);l[e]=Math.ceil(t[e].size/n)}loading(1),e(0)}else notify("请先选择文件")}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="1"}function handleDragLeave(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity=""}function handleDrop(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="";const t=e.dataTransfer,n=(t.files,t.items);for(let e=0;e<n.length;e++){const t=n[e];if("file"===t.kind&&t.webkitGetAsEntry().isFile){const e=t.getAsFile();if(e){const t=new DataTransfer;t.items.add(e),fileInput.files=t.files,selfile()}}else notify("文件夹不支持上传")}}let uploadpath,fullPath,pagenum,phonum,vidnum,curpage,pagetype,nowpath="/",editmode=0;const pagedis=document.getElementById("page-display"),bigpic=document.getElementById("bigpic"),lastpic=document.getElementById("last-btn"),nextpic=document.getElementById("next-btn"),picpage=document.getElementById("bigpic-page");window.addEventListener("scroll",handleScroll),window.onload=comin,document.getElementById("oth-btn").addEventListener("click",function(e){e.stopPropagation()}),document.addEventListener("click",function(e){showoth(1)});let scale=1;bigpic.addEventListener("wheel",e=>{e.preventDefault(),e.deltaY<0?scale+=.1:scale-=.1,scale=Math.min(Math.max(1,scale),3),bigpic.style.transform=`scale(${scale})`});let initialDistance=null;const handleTouchStart=e=>{2===e.touches.length&&(initialDistance=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY))},handleTouchMove=e=>{if(2===e.touches.length&&null!==initialDistance){const t=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY),n=t/initialDistance;scale*=n,scale=Math.min(Math.max(1,scale),3),bigpic.style.transform=`scale(${scale})`,initialDistance=t}};bigpic.addEventListener("touchstart",handleTouchStart),bigpic.addEventListener("touchmove",handleTouchMove);const pagebtn=[bigpic,lastpic,nextpic];let picmap;pagebtn.forEach(e=>{e.addEventListener("click",e=>e.stopPropagation())});const fileInput=document.getElementById("uploadfile"),uploadarea=document.getElementById("upload-area"),picbox=document.getElementById("pic-box");document.addEventListener("dragover",handleDragOver),document.addEventListener("dragleave",handleDragLeave),document.addEventListener("drop",handleDrop),picbox.addEventListener("dragover",handleDragOver),picbox.addEventListener("dragleave",handleDragLeave),picbox.addEventListener("drop",handleDrop);