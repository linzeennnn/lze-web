function optionbar(status){const optionbar=document.getElementById("option-bar"),openbtn=document.getElementById("openbar");switch(status){case 0:allmove(status),optionstatus=0,openbtn.style.display="block",optionbar.style.left="",setTimeout(()=>{optionbar.style.display="none"},1e3);break;case 1:allmove(status),optionstatus=1,optionbar.style.display="",setTimeout(()=>{openbtn.style.display="none",optionbar.style.left="0"},10)}}function allmove(status){const elements=document.querySelectorAll(".main");switch(status){case 1:elements.forEach(function(element,index){element&&(element.style.marginLeft="")});break;case 0:elements.forEach(function(element,index){element.style.marginLeft="0"})}}function handleScroll(){var scrollTop=window.scrollY||document.documentElement.scrollTop;scrollTop>100?(document.getElementById("top-btn").style.bottom="15%",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("top-bar").style.boxShadow="none",document.querySelector(".backbtn").style.left="1%",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter="none",document.getElementById("top-bar").style.webkitBackdropFilter="none"):(document.getElementById("top-btn").style.bottom="",document.getElementById("top-bar").style.top="100px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("top-bar").style.boxShadow="",document.querySelector(".backbtn").style.left="5%",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter="",document.getElementById("top-bar").style.webkitBackdropFilter="")}function comin(){creatnote(),theme(mode,"pink"),document.getElementById("allnote").style.right="0",document.getElementById("top-bar").style.top="100px",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.querySelector(".backbtn").style.left="5%",loginstatus()}function goBack(){window.location.replace(`../../index.html#${ip}`)}function reloadPage(){location.reload()}async function readfile(file){const response=await fetch(file,{cache:"no-store"}),text=await response.text();return text}async function getnote(){const timestamp=(new Date).getTime(),response=await fetch(`${protocol}//${ip}/code/Note/get_note.php?timestamp=${timestamp}`,fetchtoken()),noteFiles=await response.json();return fetchnologin(response),noteFiles}async function creatnote(){pageloading(1);const notesContainer=document.getElementById("allnote");try{const noteFiles=await getnote();for(const file of Object.values(noteFiles)){const title=file.replace(/\.[^/.]+$/,""),note=document.createElement("div");note.className="note";const notetitle=document.createElement("input");notetitle.className="title",notetitle.value=title,notetitle.title=title,notetitle.disabled=!0,note.appendChild(notetitle);const textcode=document.createElement("code");textcode.className="text",textcode.style.display="none",note.appendChild(textcode);const edit=document.createElement("div");edit.className="edit",edit.title="编辑",edit.style.display="none",edit.addEventListener("click",()=>editnote(note,1)),note.appendChild(edit);const save=document.createElement("div");save.className="save",save.addEventListener("click",()=>editnote(note,0,`${file}`)),save.style.display="none",note.appendChild(save);const copy=document.createElement("div");copy.className="copy",copy.title="复制",copy.style.display="none",note.appendChild(copy);const expend=document.createElement("div");expend.className="expend",expend.title="展开",expend.addEventListener("click",()=>loadtext(note,file)),note.appendChild(expend);const load=document.createElement("div");load.className="loading",note.appendChild(load),load.style.display="none";const close=document.createElement("div");close.className="close",close.title="合上",close.style.display="none",close.addEventListener("click",()=>notedisplay(note,0)),note.a,note.appendChild(close);const del=document.createElement("div");del.className="del",del.addEventListener("click",function(){0==editstatus?confirm("确定要删除这个便签吗？")&&delnote(`${file}`):notify("请先保存正在编辑的内容")}),note.appendChild(del),notesContainer.appendChild(note)}pageloading(0)}catch(error){console.error("Error reading files:",error)}}function notedisplay(note,action){const text=note.querySelector(".text"),expend=note.querySelector(".expend"),close=note.querySelector(".close"),edit=note.querySelector(".edit"),copy=note.querySelector(".copy");1==action?(edit.style.display="block",text.style.display="block",expend.style.display="none",close.style.display="block",copy.style.display="block"):0==action&&(edit.style.display="none",text.style.display="none",expend.style.display="block",close.style.display="none",copy.style.display="none")}function replaceNbspWithSpace(text){return text.replace(/\u00A0/g," ")}function copytext(note,text){const copy=note.querySelector(".copy"),cleanedText=replaceNbspWithSpace(text);if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(cleanedText).then(()=>{copy.style.backgroundImage="url(../../icon/yes_pink.svg)",notify("成功复制"),setTimeout(()=>{copy.style.backgroundImage="url(../../icon/copy_pink.svg)"},2e3)}).catch(err=>{console.error("Failed to copy text to clipboard: ",err)});else{const textArea=document.createElement("textarea");textArea.value=cleanedText,document.body.appendChild(textArea),textArea.select();try{document.execCommand("copy"),copy.style.backgroundImage="url(../../icon/yes_pink.svg)",notify("成功复制"),setTimeout(()=>{copy.style.backgroundImage="url(../../icon/copy_pink.svg)"},2e3)}catch(err){console.error("Failed to copy text to clipboard: ",err)}document.body.removeChild(textArea)}}function delnote(fileName,load){pageloading(1);const formData=new FormData;formData.append("fileName",fileName);const xhr=new XMLHttpRequest;xhr.open("POST",`${protocol}//${ip}/code/Note/delnote.php`,!0),xhr.setRequestHeader("Authorization","Bearer "+token),xhr.onload=function(){if(200===xhr.status){const result=JSON.parse(xhr.responseText);"success"===result.status&&0!=load&&(reloadnote(),notify("已删除"))}else console.error("Error deleting note:",xhr.statusText)},xhr.onerror=function(){console.error("Error deleting note:",xhr.statusText)},xhr.send(formData)}async function addnote(title,text,file){if(title.value.includes("%")||title.value.includes("#"))return void notify("标题包含非法字符(#或%)");""==title.value&&(title.value="new_note"),pageloading(1);const formData=new FormData;formData.append("newTitle",title.value),formData.append("newContent",text.innerText);try{const response=await fetch(`${protocol}//${ip}/code/Note/${file}`,{method:"POST",headers:{Authorization:"Bearer "+token},body:formData});if(fetchnologin(response),401!=response.status){const data=await response.json(),filename=data.filename,uploadpath=data.filepath;reloadnote(),desktopnot("恩的便签","新便签:",`${filename}`,uploadpath),title.value="",text.innerText="",notify("保存成功")}}catch(error){console.error("Error adding new note:",error)}}function editnote(note,status,file){const title=note.querySelector(".title"),text=note.querySelector(".text"),save=note.querySelector(".save"),edit=note.querySelector(".edit");1==status?0!=editstatus?notify("请先保存正在编辑的内容"):(editstatus=1,oldtitle=title.value,title.disabled=!1,title.contentEditable="true",text.contentEditable="true",text.style.borderStyle="none",text.style.borderRadius="1em",title.style.boxShadow="var(--inshadow)",text.style.boxShadow="var(--inshadow)",edit.style.display="none",save.style.display="block"):0==status&&(title.value===oldtitle?addnote(title,text,"save.php"):(delnote(file,0),addnote(title,text,"addnote.php")),editstatus=0)}async function loadtext(note,file){const text=note.querySelector(".text"),expend=note.querySelector(".expend"),loading=note.querySelector(".loading"),copy=note.querySelector(".copy");if(""!==text.innerHTML.trim())notedisplay(note,1);else{expend.style.display="none",loading.style.display="block";const title=note.querySelector(".title").value,filePath=`${protocol}//${ip}/file/Note/${title}.txt`;try{const fileContent=await readfile(filePath);text.innerHTML=hljs.highlightAuto(fileContent).value.replace(/\n/g,"<br>"),notedisplay(note,1),copy.addEventListener("click",()=>copytext(note,fileContent))}catch(error){console.error("Error loading text:",error)}finally{loading.style.display="none"}}}function reloadnote(){document.getElementById("allnote").innerHTML="",creatnote()}function selfile(){var files=document.getElementsByTagName("input")[0].files;if(0!==files.length){document.getElementById("word-bar").style.display="none",document.getElementById("progress").style.display="block";for(var fd=new FormData,i=0;i<files.length;i++){var file=files[i];if(file.size>2097152)return void notify("文件不能超过2MB");if(!file.type.match(/text.*/)&&".txt"!==file.name.slice(-4))return void notify("不支持类型");if(".txt"!==file.name.slice(-4)){var newFileName=file.name+".txt",newFile=new Blob([file],{type:file.type});newFile=new File([newFile],newFileName,{type:file.type}),fd.append("pic[]",newFile)}else fd.append("pic[]",file)}var xhr=new XMLHttpRequest;xhr.open("POST",`${protocol}//${ip}/code/Note/upload.php`,!0),xmltoken(xhr),xhr.upload.onprogress=function(ev){if(ev.lengthComputable){var percent=100*ev.loaded/ev.total,percentElement=document.getElementById("percent");document.getElementById("bar").style.width=percent+"%",percentElement.innerHTML=parseInt(percent)+"%"}},xhr.onload=function(){xhr.readyState===XMLHttpRequest.DONE&&(xmlnologin(xhr),401!=xhr.status&&(notify("添加成功"),reloadnote(),document.getElementById("word-bar").style.display="block",document.getElementById("progress").style.display="none"))},xhr.send(fd)}else notify("请先选择文件")}const titbar=document.getElementById("tit-bar"),wordbar=document.getElementById("word-bar");let oldtitle,editstatus=0;window.addEventListener("scroll",handleScroll),window.onload=comin,document.addEventListener("paste",function(event){event.preventDefault();const text=event.clipboardData.getData("text/plain");document.execCommand("insertText",!1,text)});