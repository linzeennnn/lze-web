function uploadFolder(){ifroot();const input=document.getElementById("uploadfolder"),files=input.files;if(0===files.length)return;loading(1),showupload(0);const chunkSize=1048576,totalFiles=files.length;let totalChunks=0,uploadedChunks=0,completedFiles=0;for(let file of files)totalChunks+=Math.ceil(file.size/chunkSize);const percentElement=document.getElementById("percent"),updateProgress=()=>{const percent=uploadedChunks/totalChunks*100;document.getElementById("bar").style.width=percent+"%",percentElement.innerHTML=parseInt(percent)+"%"},uploadFile=(file,index)=>{let start=0;const uploadChunk=start=>{const end=Math.min(start+chunkSize,file.size),chunk=file.slice(start,end),relativePath=file.webkitRelativePath,foldername=files[0].webkitRelativePath.split("/")[0],chunkFormData=new FormData;chunkFormData.append("file",chunk,file.name),chunkFormData.append("relativePath",relativePath),chunkFormData.append("start",start),chunkFormData.append("total",file.size),0===index&&0===start&&chunkFormData.append("1st",!0),fetch(`${protocol}//${ip}/code/Documents/upload_folder.php`,{method:"POST",body:chunkFormData}).then(response=>response.text()).then(data=>{uploadedChunks++,updateProgress(),end<file.size?uploadChunk(end):(completedFiles++,completedFiles===totalFiles&&(movefolder(foldername,nowpath),loading(0)))}).catch(error=>{console.error("上传失败:",error)})};uploadChunk(start)};for(let i=0;i<files.length;i++)uploadFile(files[i],i);input.value=""}function movefolder(foldername,folderpath){fetch(`${protocol}//${ip}/code/Documents/move_folder.php`,{method:"POST",body:new URLSearchParams({name:foldername,path:folderpath})}).then(response=>response.text()).then(data=>{notify(data),loadFolder(removeslash(folderpath))}).catch(error=>{notify(error)})}function selfile(){function uploadChunk(fileIndex){if(fileIndex>=totalFiles)loading(0);else{var file=files[fileIndex],start=currentChunks[fileIndex]*chunkSize,end=Math.min(start+chunkSize,file.size),chunk=file.slice(start,end),fd=new FormData;fd.append("file",chunk),fd.append("fileName",file.name),fd.append("totalChunks",totalChunks[fileIndex]),fd.append("currentChunk",currentChunks[fileIndex]),fd.append("nowpath",nowpath);var xhr=new XMLHttpRequest;xhr.open("POST",`${protocol}//${ip}/code/Documents/upload_file.php`,!0),xmltoken(xhr),xhr.upload.onprogress=function(ev){if(ev.lengthComputable){var percent=(currentChunks[fileIndex]+ev.loaded/ev.total)/totalChunks[fileIndex]*100,percentElement=document.getElementById("percent");document.getElementById("bar").style.width=percent+"%",percentElement.innerHTML=parseInt(percent)+"%"}},xhr.onload=function(){xmlnologin(xhr),200===xhr.status&&(currentChunks[fileIndex]++,currentChunks[fileIndex]<totalChunks[fileIndex]?uploadChunk(fileIndex):(uploadChunk(fileIndex+1),notify(`文件 ${file.name} 上传成功`),uploadpath=xhr.responseText,loadFolder(removeslash(nowpath)),desktopnot("新文件",`新上传文件: ${file.name}`,uploadpath)))},xhr.send(fd)}}ifroot();var files=fileInput.files;if(0!==files.length){showupload(0);var chunkSize=1048576,totalFiles=files.length,totalChunks=Array(totalFiles).fill(0),currentChunks=Array(totalFiles).fill(0);for(let i=0;i<totalFiles;i++){if(0===files[i].size)return void notify(`${files[i].name} 是空文件，上传失败`);totalChunks[i]=Math.ceil(files[i].size/chunkSize)}loading(1),uploadChunk(0)}else notify("请先选择文件")}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="1"}function handleDragLeave(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity=""}function handleDrop(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="";const dt=e.dataTransfer,items=(dt.files,dt.items);for(let i=0;i<items.length;i++){const item=items[i];if("file"===item.kind&&item.webkitGetAsEntry().isFile){const file=item.getAsFile();if(file){const dataTransfer=new DataTransfer;dataTransfer.items.add(file),fileInput.files=dataTransfer.files,selfile()}}else notify("文件夹自己去手动上传")}}const folderinput=document.getElementById("uploadfolder"),fileInput=document.getElementById("uploadfile"),uploadarea=document.getElementById("upload-area"),filelist=document.getElementById("fileListContainer");document.addEventListener("dragover",handleDragOver),document.addEventListener("dragleave",handleDragLeave),document.addEventListener("drop",handleDrop),filelist.addEventListener("dragover",handleDragOver),filelist.addEventListener("dragleave",handleDragLeave),filelist.addEventListener("drop",handleDrop);