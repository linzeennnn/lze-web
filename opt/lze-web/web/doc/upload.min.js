function uploadFolder(){ifroot();const e=document.getElementById("uploadfolder"),t=e.files;if(0===t.length)return;loading(1),showupload(0);const n=1048576,o=t.length;let a=0,l=0,d=0;for(let e of t)a+=Math.ceil(e.size/n);const i=document.getElementById("percent"),r=()=>{const e=l/a*100;document.getElementById("bar").style.width=e+"%",i.innerHTML=parseInt(e)+"%"},p=(e,a)=>{let i=0;const p=i=>{const s=Math.min(i+n,e.size),f=e.slice(i,s),c=e.webkitRelativePath,u=t[0].webkitRelativePath.split("/")[0],h=new FormData;h.append("file",f,e.name),h.append("relativePath",c),h.append("start",i),h.append("total",e.size),0===a&&0===i&&h.append("1st",!0),fetch(`${protocol}//${ip}/code/Documents/upload_folder.php`,{method:"POST",body:h}).then(e=>e.text()).then(t=>{l++,r(),s<e.size?p(s):(d++,d===o&&(movefolder(u,nowpath),loading(0)))}).catch(e=>{console.error("上传失败:",e)})};p(i)};for(let e=0;e<t.length;e++)p(t[e],e);e.value=""}function movefolder(e,t){fetch(`${protocol}//${ip}/code/Documents/move_folder.php`,{method:"POST",body:new URLSearchParams({name:e,path:t})}).then(e=>e.text()).then(e=>{notify(e),loadFolder(removeslash(t))}).catch(e=>{notify(e)})}function selfile(){function e(d){if(d>=o)loading(0);else{var i=t[d],r=l[d]*n,p=Math.min(r+n,i.size),s=i.slice(r,p),f=new FormData;f.append("file",s),f.append("fileName",i.name),f.append("totalChunks",a[d]),f.append("currentChunk",l[d]),f.append("nowpath",nowpath);var c=new XMLHttpRequest;c.open("POST",`${protocol}//${ip}/code/Documents/upload_file.php`,!0),xmltoken(c),c.upload.onprogress=function(e){if(e.lengthComputable){var t=(l[d]+e.loaded/e.total)/a[d]*100,n=document.getElementById("percent");document.getElementById("bar").style.width=t+"%",n.innerHTML=parseInt(t)+"%"}},c.onload=function(){xmlnologin(c),200===c.status&&(l[d]++,l[d]<a[d]?e(d):(e(d+1),notify(`文件 ${i.name} 上传成功`),uploadpath=c.responseText,loadFolder(removeslash(nowpath)),desktopnot("新文件",`新上传文件: ${i.name}`,uploadpath)))},c.send(f)}}ifroot();var t=fileInput.files;if(0!==t.length){showupload(0);var n=1048576,o=t.length,a=Array(o).fill(0),l=Array(o).fill(0);for(let e=0;e<o;e++){if(0===t[e].size)return void notify(`${t[e].name} 是空文件，上传失败`);a[e]=Math.ceil(t[e].size/n)}loading(1),e(0)}else notify("请先选择文件")}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="1"}function handleDragLeave(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity=""}function handleDrop(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="";const t=e.dataTransfer,n=(t.files,t.items);for(let e=0;e<n.length;e++){const t=n[e];if("file"===t.kind&&t.webkitGetAsEntry().isFile){const e=t.getAsFile();if(e){const t=new DataTransfer;t.items.add(e),fileInput.files=t.files,selfile()}}else notify("文件夹自己去手动上传")}}const folderinput=document.getElementById("uploadfolder"),fileInput=document.getElementById("uploadfile"),uploadarea=document.getElementById("upload-area"),filelist=document.getElementById("fileListContainer");document.addEventListener("dragover",handleDragOver),document.addEventListener("dragleave",handleDragLeave),document.addEventListener("drop",handleDrop),filelist.addEventListener("dragover",handleDragOver),filelist.addEventListener("dragleave",handleDragLeave),filelist.addEventListener("drop",handleDrop);