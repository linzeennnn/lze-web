function optionbar(status){const optionbar=document.getElementById("option-bar"),openbtn=document.getElementById("openbar");switch(status){case 0:allmove(status),optionstatus=0,openbtn.style.display="block",optionbar.style.left="",setTimeout(()=>{optionbar.style.display="none"},1e3);break;case 1:allmove(status),optionstatus=1,optionbar.style.display="",setTimeout(()=>{openbtn.style.display="none",optionbar.style.left="0"},10)}}function allmove(status){const elements=document.querySelectorAll(".main");switch(status){case 1:elements.forEach(function(element,index){element&&(element.style.marginLeft="")});break;case 0:elements.forEach(function(element,index){element.style.marginLeft="0"})}}function handleScroll(){var scrollTop=window.scrollY||document.documentElement.scrollTop;scrollTop>100?(document.getElementById("top-btn").style.bottom="90px",document.querySelector(".backbtn").style.left="1%",document.getElementById("top-bar").style.boxShadow="none",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter="none",document.getElementById("top-bar").style.webkitBackdropFilter="none"):(document.getElementById("top-btn").style.bottom="",document.querySelector(".backbtn").style.left="5%",document.getElementById("top-bar").style.boxShadow="",document.getElementById("top-bar").style.top="77px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter="",document.getElementById("top-bar").style.webkitBackdropFilter="")}function comin(){access(),loadFolder(),theme(mode,"orange"),document.querySelector(".backbtn").style.left="5%",document.getElementById("fileListContainer").style.opacity="1",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.getElementById("top-bar").style.top="77px",loginstatus()}function goBack(){window.location.replace(`../../index.html#${ip}`)}function pathlen(textid,text){const barWidth=textid.offsetWidth,tempElement=document.createElement("span");tempElement.style.visibility="hidden",tempElement.style.position="absolute",tempElement.style.font=window.getComputedStyle(textid).font,tempElement.innerText="字",document.body.appendChild(tempElement);const charWidth=tempElement.offsetWidth;document.body.removeChild(tempElement);const maxLength=Math.floor(barWidth/charWidth);let displayPath=text;text.length>maxLength&&"currentPath"===textid.id?displayPath="..."+text.slice(-maxLength):text.length>maxLength&&(displayPath=text.slice(0,maxLength)+"..."),textid.innerText=displayPath}async function loadFolder(folder=""){selectedarray.length=0;try{const response=await fetch(`${protocol}//${ip}/code/trash/trash_list.php?folder=`+folder);fetchnologin(response);const data=await response.json(),fileList=document.getElementById("fileList");fileList.innerHTML="";const currentPath=document.getElementById("currentPath");fullPath=(data.currentFolder?data.currentFolder:"")+"/",pathlen(currentPath,fullPath),currentPath.title=fullPath,data.folders.forEach(folder=>{const listItem=document.createElement("li");listItem.className="files";const folderLink=document.createElement("span");folderLink.textContent=folder,folderLink.classList.add("folderLink","filename"),listItem.addEventListener("click",function(){select(listItem,2)}),folderLink.addEventListener("click",function(event){event.stopPropagation(),event.target.isContentEditable||loadFolder(data.currentFolder?data.currentFolder+"/"+folder:folder)}),listItem.appendChild(folderLink),fileList.appendChild(listItem)}),data.files.forEach(file=>{const listItem=document.createElement("li");listItem.className="files";const fileLink=document.createElement("span");protocol,ip,data.currentFolder&&data.currentFolder,document.getElementById("fileListContainer");fileLink.textContent=file,fileLink.classList.add("fileLink","filename"),fileLink.title=`预览${file}`,listItem.addEventListener("click",function(){select(listItem,1)}),fileLink.addEventListener("click",function(event){if(event.stopPropagation(),event.target.isContentEditable)return;let filepath;nowpath=fullPath;let rootpath=`${protocol}//${ip}/file/trash/`;filepath="/"===nowpath?rootpath+file:rootpath+nowpath+file,window.location.href=filepath}),listItem.appendChild(fileLink),fileList.appendChild(listItem)});const upButton=document.getElementById("upButton");data.currentFolder&&""!==data.currentFolder?(upButton.style.display="block",upButton.dataset.parentFolder=data.parentFolder,upButton.style.pointerEvents="auto"):upButton.style.pointerEvents="none",getpath()}catch(error){console.error("Error loading folder:",error)}}async function getpath(){const response=await fetch(`${protocol}//${ip}/file/data/deleted_metadata.json`,{method:"GET",cache:"no-cache"}),data=await response.json(),trashfilename=Object.keys(data),filename=document.querySelectorAll(".filename");filename.forEach(filename=>{if(trashfilename.includes(filename.innerText)){const oripath=document.createElement("span");oripath.className="oripath",oripath.innerText=data[filename.innerText].replace("../../file/Documents/upload","")||"/",filename.insertAdjacentElement("afterend",oripath)}else{const oripath=document.createElement("span");oripath.className="oripath",oripath.innerText="/"+filename.innerText,filename.insertAdjacentElement("afterend",oripath)}})}function goUp(){const upButton=document.getElementById("upButton"),parentFolder=upButton.dataset.parentFolder;loadFolder(parentFolder)}function ifroot(){nowpath="/"==fullPath?"":fullPath}function recover(){access(),ifroot(),fetch(`${protocol}//${ip}/code/trash/recover.php`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify(pathsMap)}).then(response=>{if(401===response.status)throw new Error("未授权访问")}).then(results=>{selectedarray.length,loadFolder(removeslash(nowpath)),notify("已恢复"),selectedarray.length=0}).catch(error=>{console.error("错误:",error)})}function select(fileitem,type){let filesname;switch(type){case 1:filesname=fileitem.querySelector(".fileLink");break;case 2:filesname=fileitem.querySelector(".folderLink")}selectedpath=fullPath+filesname.innerText,recoverpath=fileitem.querySelector(".oripath").innerText,pathsMap[selectedpath]=recoverpath,fileitem.classList.contains("selected")?(notify("取消选择"),fileitem.classList.remove("selected"),index=selectedarray.indexOf(selectedpath),selectedarray.splice(index,1),delete pathsMap[selectedpath]):(selectcount=selectedarray.length+1,notify("已选择"+selectcount+"个文件"),fileitem.classList.add("selected"),selectedarray.push(selectedpath))}function removeslash(path){return path.endsWith("/")?path.slice(0,-1):path}function cleanall(){confirm("确定清空回收站吗")&&(ifroot(),fetch(`${protocol}//${ip}/code/trash/del.php`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token}}).then(response=>response.json()).then(data=>{"success"===data.status?(console.log(data.message),loadFolder(removeslash(nowpath)),notify("已清空")):console.error(data.message)}).catch(error=>console.error("Error:",error)))}let uploadpath,fullPath,filesname,selectedpath,nowpath="/",editmode=0;window.addEventListener("scroll",handleScroll),window.onload=comin;let index,selectcount,recoverpath,selectedarray=[],pathsMap={};