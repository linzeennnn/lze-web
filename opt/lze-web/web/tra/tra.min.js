function optionbar(e){const t=document.getElementById("option-bar"),o=document.getElementById("openbar");switch(e){case 0:allmove(e),optionstatus=0,o.style.display="block",t.style.left="",setTimeout(()=>{t.style.display="none"},1e3);break;case 1:allmove(e),optionstatus=1,t.style.display="",setTimeout(()=>{o.style.display="none",t.style.left="0"},10)}}function allmove(e){const t=document.querySelectorAll(".main");switch(e){case 1:t.forEach(function(e,t){e&&(e.style.marginLeft="")});break;case 0:t.forEach(function(e,t){e.style.marginLeft="0"})}}function handleScroll(){var e=window.scrollY||document.documentElement.scrollTop;e>100?(document.getElementById("top-btn").style.bottom="90px",document.querySelector(".backbtn").style.left="1%",document.getElementById("top-bar").style.boxShadow="none",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter="none",document.getElementById("top-bar").style.webkitBackdropFilter="none"):(document.getElementById("top-btn").style.bottom="",document.querySelector(".backbtn").style.left="5%",document.getElementById("top-bar").style.boxShadow="",document.getElementById("top-bar").style.top="77px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter="",document.getElementById("top-bar").style.webkitBackdropFilter="")}function comin(){access(),loadFolder(),theme(mode,"orange"),document.querySelector(".backbtn").style.left="5%",document.getElementById("fileListContainer").style.opacity="1",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.getElementById("top-bar").style.top="77px",loginstatus()}function goBack(){window.location.replace(`../../index.html#${ip}`)}function pathlen(e,t){const o=e.offsetWidth,n=document.createElement("span");n.style.visibility="hidden",n.style.position="absolute",n.style.font=window.getComputedStyle(e).font,n.innerText="字",document.body.appendChild(n);const l=n.offsetWidth;document.body.removeChild(n);const a=Math.floor(o/l);let c=t;t.length>a&&"currentPath"===e.id?c="..."+t.slice(-a):t.length>a&&(c=t.slice(0,a)+"..."),e.innerText=c}async function loadFolder(e=""){selectedarray.length=0;try{const t=await fetch(`${protocol}//${ip}/code/trash/trash_list.php?folder=`+e);fetchnologin(t);const o=await t.json(),n=document.getElementById("fileList");n.innerHTML="";const l=document.getElementById("currentPath");fullPath=(o.currentFolder?o.currentFolder:"")+"/",pathlen(l,fullPath),l.title=fullPath,o.folders.forEach(e=>{const t=document.createElement("li");t.className="files";const l=document.createElement("span");l.textContent=e,l.classList.add("folderLink","filename"),t.addEventListener("click",function(){select(t,2)}),l.addEventListener("click",function(t){t.stopPropagation(),t.target.isContentEditable||loadFolder(o.currentFolder?o.currentFolder+"/"+e:e)}),t.appendChild(l),n.appendChild(t)}),o.files.forEach(e=>{const t=document.createElement("li");t.className="files";const l=document.createElement("span");protocol,ip,o.currentFolder&&o.currentFolder,document.getElementById("fileListContainer");l.textContent=e,l.classList.add("fileLink","filename"),l.title=`预览${e}`,t.addEventListener("click",function(){select(t,1)}),l.addEventListener("click",function(t){if(t.stopPropagation(),t.target.isContentEditable)return;let o;nowpath=fullPath;let n=`${protocol}//${ip}/file/trash/`;o="/"===nowpath?n+e:n+nowpath+e,window.location.href=o}),t.appendChild(l),n.appendChild(t)});const a=document.getElementById("upButton");o.currentFolder&&""!==o.currentFolder?(a.style.display="block",a.dataset.parentFolder=o.parentFolder,a.style.pointerEvents="auto"):a.style.pointerEvents="none",getpath()}catch(e){console.error("Error loading folder:",e)}}async function getpath(){const e=await fetch(`${protocol}//${ip}/file/data/deleted_metadata.json`,{method:"GET",cache:"no-cache"}),t=await e.json(),o=Object.keys(t),n=document.querySelectorAll(".filename");n.forEach(e=>{if(o.includes(e.innerText)){const o=document.createElement("span");o.className="oripath",o.innerText=t[e.innerText].replace("../../file/Documents/upload","")||"/",e.insertAdjacentElement("afterend",o)}else{const t=document.createElement("span");t.className="oripath",t.innerText="/"+e.innerText,e.insertAdjacentElement("afterend",t)}})}function goUp(){const e=document.getElementById("upButton"),t=e.dataset.parentFolder;loadFolder(t)}function ifroot(){nowpath="/"==fullPath?"":fullPath}function recover(){access(),ifroot(),fetch(`${protocol}//${ip}/code/trash/recover.php`,{method:"POST",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},body:JSON.stringify(pathsMap)}).then(e=>{if(401===e.status)throw new Error("未授权访问")}).then(e=>{selectedarray.length,loadFolder(removeslash(nowpath)),notify("已恢复"),selectedarray.length=0}).catch(e=>{console.error("错误:",e)})}function select(e,t){let o;switch(t){case 1:o=e.querySelector(".fileLink");break;case 2:o=e.querySelector(".folderLink")}selectedpath=fullPath+o.innerText,recoverpath=e.querySelector(".oripath").innerText,pathsMap[selectedpath]=recoverpath,e.classList.contains("selected")?(notify("取消选择"),e.classList.remove("selected"),index=selectedarray.indexOf(selectedpath),selectedarray.splice(index,1),delete pathsMap[selectedpath]):(selectcount=selectedarray.length+1,notify("已选择"+selectcount+"个文件"),e.classList.add("selected"),selectedarray.push(selectedpath))}function removeslash(e){return e.endsWith("/")?e.slice(0,-1):e}function cleanall(){confirm("确定清空回收站吗")&&(ifroot(),fetch(`${protocol}//${ip}/code/trash/del.php`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token}}).then(e=>e.json()).then(e=>{"success"===e.status?(console.log(e.message),loadFolder(removeslash(nowpath)),notify("已清空")):console.error(e.message)}).catch(e=>console.error("Error:",e)))}let uploadpath,fullPath,filesname,selectedpath,nowpath="/",editmode=0;window.addEventListener("scroll",handleScroll),window.onload=comin;let index,selectcount,recoverpath,selectedarray=[],pathsMap={};