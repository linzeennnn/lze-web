function optionbar(status){const optionbar=document.getElementById("option-bar"),openbtn=document.getElementById("openbar");switch(status){case 0:allmove(status),optionstatus=0,openbtn.style.display="block",optionbar.style.left="",setTimeout(()=>{optionbar.style.display="none"},1e3);break;case 1:allmove(status),optionstatus=1,optionbar.style.display="",setTimeout(()=>{openbtn.style.display="none",optionbar.style.left="0"},10)}}function allmove(status){const elements=document.querySelectorAll(".main");switch(status){case 1:elements.forEach(function(element,index){element&&(element.style.marginLeft="")});break;case 0:elements.forEach(function(element,index){element.style.marginLeft="0"})}}function handleScroll(){var scrollTop=window.scrollY||document.documentElement.scrollTop;scrollTop>100?(document.getElementById("top-btn").style.bottom="200px",document.querySelector(".backbtn").style.left="1%",document.getElementById("top-bar").style.boxShadow="none",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter="none",document.getElementById("top-bar").style.webkitBackdropFilter="none"):(document.getElementById("top-btn").style.bottom="",document.querySelector(".backbtn").style.left="5%",document.getElementById("top-bar").style.boxShadow="",document.getElementById("top-bar").style.top="77px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter="",document.getElementById("top-bar").style.webkitBackdropFilter="")}function comin(){access(),loadFolder(),theme(mode,"blue"),document.querySelector(".backbtn").style.left="5%",document.getElementById("fileListContainer").style.opacity="1",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.getElementById("top-bar").style.top="77px",loginstatus()}function goBack(){window.location.replace(`../../index.html#${ip}`)}function loading(status){const fileInput=document.getElementById("uploadfile"),folderInput=document.getElementById("uploadfolder"),load=document.getElementById("loading"),loadbox=document.getElementById("rotate-box"),goupbtn=(document.getElementById("load-text"),document.getElementById("upButton")),path=document.getElementById("currentPath"),progress=document.getElementById("progress");switch(status){case 1:if(0===fileInput.files.length&&0===folderInput.files.length)return void notify("请先选择一个文件进行上传");path.style.display="none",goupbtn.style.display="none",progress.style.display="block",load.style.display="block",loadbox.style.display="block";break;case 0:path.style.display="",goupbtn.style.display="",progress.style.display="none",load.style.display="none",loadbox.style.display="none"}}function pathlen(textid,text){const barWidth=textid.offsetWidth,tempElement=document.createElement("span");tempElement.style.visibility="hidden",tempElement.style.position="absolute",tempElement.style.font=window.getComputedStyle(textid).font,tempElement.innerText="字",document.body.appendChild(tempElement);const charWidth=tempElement.offsetWidth;document.body.removeChild(tempElement);const maxLength=Math.floor(barWidth/charWidth);let displayPath=text;text.length>maxLength&&"currentPath"===textid.id?displayPath="..."+text.slice(-maxLength):text.length>maxLength&&(displayPath=text.slice(0,maxLength)+"..."),textid.innerText=displayPath}async function loadFolder(folder=""){pageloading(1),curpage=1;try{const response=await fetch(`${protocol}//${ip}/code/Pictures/pic_list.php?folder=`+folder);fetchnologin(response);const data=await response.json();let phoindex=0,vidindex=0;phonum=1,vidnum=1;const othlist=document.getElementById("oth-list"),picbox=document.getElementById("pic-box");picbox.innerHTML="",othlist.innerHTML="";const currentPath=document.getElementById("currentPath");fullPath=(data.currentFolder?data.currentFolder:"")+"/",pathlen(currentPath,fullPath),currentPath.title=fullPath,data.folders.forEach(folder=>{const dir=document.createElement("div");dir.classList.add("folder"),dir.innerText=folder,dir.title=folder,dir.addEventListener("click",function(event){event.stopPropagation(),event.target.isContentEditable||loadFolder(data.currentFolder?data.currentFolder+"/"+folder:folder)}),othlist.appendChild(dir)}),data.files.forEach(file=>{const load=document.createElement("div"),pic=document.createElement("div");let picfile;pic.classList.add("pic"),load.classList.add("load-loop"),pic.addEventListener("click",function(){openpic(1,folder+"/"+file)}),1==isvideo(file)?(pic.classList.add("video"),picfile=document.createElement("video"),vidindex%9==0&&0!=vidindex&&vidnum++,pic.classList.add(`vid-page${vidnum}`),vidindex++):(pic.classList.add("photo"),picfile=document.createElement("img"),phoindex%9==0&&0!=phoindex&&phonum++,pic.classList.add(`pho-page${phonum}`),phoindex++),picfile.setAttribute("loading","lazy"),picfile.draggable=!1,pic.title="查看"+file,picfile.src=`${protocol}//${ip}/file/Pictures/${folder}/${file}`,pic.append(load),pic.append(picfile),picbox.appendChild(pic),picfile.onload=function(){load.style.display="none"},picfile.addEventListener("loadeddata",function(){load.style.display="none"})}),pageloading(0);const upButton=document.getElementById("upButton");data.currentFolder&&""!==data.currentFolder?(upButton.style.display="block",upButton.dataset.parentFolder=data.parentFolder,upButton.style.pointerEvents="auto"):upButton.style.pointerEvents="none",pagenum=phonum,showpic("pho")}catch(error){console.error("Error loading folder:",error),pageloading(0)}}function goUp(){const upButton=document.getElementById("upButton"),parentFolder=upButton.dataset.parentFolder;loadFolder(parentFolder)}function ifroot(){nowpath="/"==fullPath?"":fullPath}function removeslash(path){return path.endsWith("/")?path.slice(0,-1):path}function clickable(status){switch(status){case 0:document.body.style.pointerEvents="none";break;case 1:document.body.style.pointerEvents="auto"}}function showoth(place){const dirbar=document.getElementById("oth-list");"flex"==dirbar.style.display||1==place?dirbar.style.display="none":dirbar.style.display="flex"}function isvideo(name){const ext=[".mp4",".avi",".mov",".wmv",".mkv",".ts",".webm",".flv",".m4v",".3gp",".mpeg",".rmvb",".vob"],nameext=name.slice(2+(name.lastIndexOf(".")-1>>>0)).toLowerCase();return ext.includes(`.${nameext}`)?1:0}function displaypage(num,cunum,type){document.querySelectorAll(`.${type}-page${cunum}`).forEach(page=>{page.style.display="none"}),document.querySelectorAll(`.${type}-page${num}`).forEach(page=>{page.style.display="flex"}),0==cunum&&pagenumdis(curpage,pagenum)}function switchpage(status){switch(status){case 1:curpage<pagenum?(displaypage(curpage+1,curpage,pagetype),curpage++):notify("已是尾页");break;case 0:curpage>1?(displaypage(curpage-1,curpage,pagetype),curpage--):notify("已是首页")}pagenumdis(curpage,pagenum)}function showpic(type){document.querySelectorAll(".photo"),document.querySelectorAll(".video");switch(type){case"pho":pagenum=phonum,document.querySelectorAll(".video").forEach(page=>{page.style.display="none"});break;case"vid":pagenum=vidnum,document.querySelectorAll(".photo").forEach(page=>{page.style.display="none"})}curpage=1,pagetype=type,displaypage(curpage,0,type)}function pagenumdis(cu,tol){pagedis.innerText=cu+"页/"+tol+"页"}function openpic(status,path){let pic;switch(status){case 1:picpage.style.display="flex","pho"==pagetype?pic=document.createElement("img"):(pic=document.createElement("video"),pic.controls=!0,pic.autoplay=!0),pic.id="page-pic",pic.draggable=!1,pic.src=`${protocol}//${ip}/file/Pictures/${path}`,bigpic.appendChild(pic),picmap="pho"==pagetype?Array.from(document.querySelectorAll("img")).filter(img=>img.offsetWidth>0&&img.offsetHeight>0).map(img=>img.src):Array.from(document.querySelectorAll("video")).filter(video=>video.offsetWidth>0&&video.offsetHeight>0).map(video=>video.src);break;case 0:bigpic.removeChild(document.getElementById("page-pic")),picpage.style.display="none"}}function switchpic(status){let link=document.getElementById("page-pic").src;const index=picmap.indexOf(link);switch(status){case 1:link=index<picmap.length-1?picmap[index+1]:picmap[0];break;case 0:link=index>0?picmap[index-1]:picmap[picmap.length-1]}document.getElementById("page-pic").src=link}function selfile(){function uploadChunk(fileIndex){if(fileIndex>=totalFiles)loading(0);else{var file=files[fileIndex],start=currentChunks[fileIndex]*chunkSize,end=Math.min(start+chunkSize,file.size),chunk=file.slice(start,end),fd=new FormData;fd.append("file",chunk),fd.append("fileName",file.name),fd.append("totalChunks",totalChunks[fileIndex]),fd.append("currentChunk",currentChunks[fileIndex]),fd.append("nowpath",nowpath);var xhr=new XMLHttpRequest;xhr.open("POST",`${protocol}//${ip}/code/Pictures/upload_file.php`,!0),xmltoken(xhr),xhr.upload.onprogress=function(ev){if(ev.lengthComputable){var percent=(currentChunks[fileIndex]+ev.loaded/ev.total)/totalChunks[fileIndex]*100,percentElement=document.getElementById("percent");document.getElementById("bar").style.width=percent+"%",percentElement.innerHTML=parseInt(percent)+"%"}},xhr.onload=function(){xmlnologin(xhr),200===xhr.status&&(currentChunks[fileIndex]++,currentChunks[fileIndex]<totalChunks[fileIndex]?uploadChunk(fileIndex):(uploadChunk(fileIndex+1),notify(`文件 ${file.name} 上传成功`),uploadpath=xhr.responseText,loadFolder(removeslash(nowpath)),desktopnot("新文件",`新上传文件: ${file.name}`,uploadpath)))},xhr.send(fd)}}ifroot();var files=fileInput.files;if(0!==files.length){var chunkSize=1048576,totalFiles=files.length,totalChunks=Array(totalFiles).fill(0),currentChunks=Array(totalFiles).fill(0);for(let i=0;i<totalFiles;i++){if(0===files[i].size)return void notify(`${files[i].name} 是空文件，上传失败`);totalChunks[i]=Math.ceil(files[i].size/chunkSize)}loading(1),uploadChunk(0)}else notify("请先选择文件")}function handleDragOver(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="1"}function handleDragLeave(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity=""}function handleDrop(e){e.stopPropagation(),e.preventDefault(),uploadarea.style.opacity="";const dt=e.dataTransfer,items=(dt.files,dt.items);for(let i=0;i<items.length;i++){const item=items[i];if("file"===item.kind&&item.webkitGetAsEntry().isFile){const file=item.getAsFile();if(file){const dataTransfer=new DataTransfer;dataTransfer.items.add(file),fileInput.files=dataTransfer.files,selfile()}}else notify("文件夹不支持上传")}}let uploadpath,fullPath,pagenum,phonum,vidnum,curpage,pagetype,nowpath="/",editmode=0;const pagedis=document.getElementById("page-display"),bigpic=document.getElementById("bigpic"),lastpic=document.getElementById("last-btn"),nextpic=document.getElementById("next-btn"),picpage=document.getElementById("bigpic-page");window.addEventListener("scroll",handleScroll),window.onload=comin,document.getElementById("oth-btn").addEventListener("click",function(event){event.stopPropagation()}),document.addEventListener("click",function(event){showoth(1)});let scale=1;bigpic.addEventListener("wheel",event=>{event.preventDefault(),event.deltaY<0?scale+=.1:scale-=.1,scale=Math.min(Math.max(1,scale),3),bigpic.style.transform=`scale(${scale})`});let initialDistance=null;const handleTouchStart=event=>{2===event.touches.length&&(initialDistance=Math.hypot(event.touches[0].clientX-event.touches[1].clientX,event.touches[0].clientY-event.touches[1].clientY))},handleTouchMove=event=>{if(2===event.touches.length&&null!==initialDistance){const currentDistance=Math.hypot(event.touches[0].clientX-event.touches[1].clientX,event.touches[0].clientY-event.touches[1].clientY),scaleChange=currentDistance/initialDistance;scale*=scaleChange,scale=Math.min(Math.max(1,scale),3),bigpic.style.transform=`scale(${scale})`,initialDistance=currentDistance}};bigpic.addEventListener("touchstart",handleTouchStart),bigpic.addEventListener("touchmove",handleTouchMove);const pagebtn=[bigpic,lastpic,nextpic];let picmap;pagebtn.forEach(pagebtn=>{pagebtn.addEventListener("click",event=>event.stopPropagation())});const fileInput=document.getElementById("uploadfile"),uploadarea=document.getElementById("upload-area"),picbox=document.getElementById("pic-box");document.addEventListener("dragover",handleDragOver),document.addEventListener("dragleave",handleDragLeave),document.addEventListener("drop",handleDrop),picbox.addEventListener("dragover",handleDragOver),picbox.addEventListener("dragleave",handleDragLeave),picbox.addEventListener("drop",handleDrop);