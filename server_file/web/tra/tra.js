let uploadpath,nowpath="/",fullPath,editmode=0;function optionbar(e){const t=document.getElementById("option-bar"),n=document.getElementById("openbar");switch(e){case 0:allmove(e),optionstatus=0,n.style.display="block",t.style.left="",setTimeout(()=>{t.style.display="none"},1e3);break;case 1:allmove(e),optionstatus=1,t.style.display="",setTimeout(()=>{n.style.display="none",t.style.left="0"},10);break}}function allmove(e){const t=document.querySelectorAll(".main");switch(e){case 1:t.forEach(function(e){e&&(e.style.marginLeft="")});break;case 0:t.forEach(function(e){e.style.marginLeft="0"});break}}function handleScroll(){var e=window.scrollY||document.documentElement.scrollTop;e>100?(document.getElementById("top-btn").style.bottom="90px",document.querySelector(".backbtn").style.left="1%",document.getElementById("top-bar").style.boxShadow="none",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter=`none`,document.getElementById("top-bar").style.webkitBackdropFilter=`none`):(document.getElementById("top-btn").style.bottom="",document.querySelector(".backbtn").style.left="5%",document.getElementById("top-bar").style.boxShadow="",document.getElementById("top-bar").style.top="77px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter=``,document.getElementById("top-bar").style.webkitBackdropFilter=``)}window.addEventListener("scroll",handleScroll);function comin(){loadFolder(),theme(mode,"orange"),document.querySelector(".backbtn").style.left="5%",document.getElementById("fileListContainer").style.opacity="1",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.getElementById("top-bar").style.top=`77px`}window.onload=comin;function goBack(){window.location.replace(`../../index.html#${ip}`)}function pathlen(e,t){const i=e.offsetWidth,n=document.createElement("span");n.style.visibility="hidden",n.style.position="absolute",n.style.font=window.getComputedStyle(e).font,n.innerText="字",document.body.appendChild(n);const a=n.offsetWidth;document.body.removeChild(n);const s=Math.floor(i/a);let o=t;t.length>s&&e.id==="currentPath"?o="..."+t.slice(-s):t.length>s&&(o=t.slice(0,s)+"..."),e.innerText=o}async function loadFolder(e=""){selectedarray.length=0;try{const i=await fetch(`${protocol}//${ip}/server/tra/list.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder:e})}),t=await i.json(),a=t.file_list[0],s=document.getElementById("fileList");s.innerHTML="";const o=document.getElementById("currentPath");fullPath=(t.currentFolder?t.currentFolder:"")+"/",pathlen(o,fullPath),o.title=fullPath;for(const[e,n]of Object.entries(a)){if(n==="file"||n==="link_file"){const n=document.createElement("li");n.className="files";const o=document.createElement("span"),i=`${protocol}//${ip}/file/trash/`+(t.currentFolder?t.currentFolder+"/"+e:e),a=document.getElementById("fileListContainer");o.textContent=e,o.classList.add("fileLink","filename"),o.title=`预览${e}`,n.addEventListener("click",function(){select(n,1)}),o.addEventListener("click",function(t){if(t.stopPropagation(),t.target.isContentEditable)return;let n;nowpath=fullPath;let s=`${protocol}//${ip}/file/trash/`;nowpath==="/"?n=s+e:n=s+nowpath+e,window.location.href=n}),n.appendChild(o),s.appendChild(n)}if(n==="folder"||n==="link_dir"){const n=document.createElement("li");n.className="files";const o=document.createElement("span");o.textContent=e,o.classList.add("folderLink","filename"),n.addEventListener("click",function(){select(n,2)}),o.addEventListener("click",function(n){if(n.stopPropagation(),n.target.isContentEditable)return;loadFolder(t.currentFolder?t.currentFolder+"/"+e:e)}),n.appendChild(o),s.appendChild(n)}}const n=document.getElementById("upButton");t.currentFolder&&t.currentFolder!==""?(n.style.display="block",n.dataset.parentFolder=t.parentFolder,n.style.pointerEvents="auto"):n.style.pointerEvents="none",getpath()}catch(e){console.error("Error loading folder:",e)}}async function getpath(){const t=await fetch(`${protocol}//${ip}/file/data/deleted_metadata.json`,{method:"GET",cache:"no-cache"}),e=await t.json(),n=Object.keys(e),s=document.querySelectorAll(".filename");s.forEach(t=>{if(n.includes(t.innerText)){const n=document.createElement("span");n.className="oripath",n.innerText=e[t.innerText].replace("../../file/Documents","")||"/",t.insertAdjacentElement("afterend",n)}else{const e=document.createElement("span");e.className="oripath",e.innerText="/"+t.innerText,t.insertAdjacentElement("afterend",e)}})}function goUp(){const e=document.getElementById("upButton"),t=e.dataset.parentFolder;loadFolder(t)}function ifroot(){fullPath=="/"?nowpath="":nowpath=fullPath}let filesname,selectedpath,selectedarray=[],index,selectcount,recoverpath,recover_list=[];function recover(){if(confirm("确定恢复吗")){ifroot();let e={recover_list,user,token};fetch(`${protocol}//${ip}/server/tra/recover.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>{if(e.ok)selectedarray.length==0,loadFolder(removeslash(nowpath)),notify("已恢复"),selectedarray.length=0;else throw e.status===401?(selectedarray.length==0,loadFolder(removeslash(nowpath)),notify("无恢复权限"),selectedarray.length=0,new Error("未授权访问")):(selectedarray.length==0,loadFolder(removeslash(nowpath)),notify(e.status+"错误"),selectedarray.length=0,new Error("未授权访问"))}).catch(e=>{console.error("错误:",e)})}}function select(e,t){let n;switch(t){case 1:n=e.querySelector(".fileLink");break;case 2:n=e.querySelector(".folderLink");break}selectedpath=fullPath+n.innerText,e.classList.contains("selected")?(notify("取消选择"),e.classList.remove("selected"),index=selectedarray.indexOf(selectedpath),selectedarray.splice(index,1),recover_list.splice(recover_list.indexOf(selectedpath),1)):(selectcount=selectedarray.length+1,notify("已选择"+selectcount+"个文件"),e.classList.add("selected"),selectedarray.push(selectedpath),recover_list.push(selectedpath))}function removeslash(e){return e.endsWith("/")?e.slice(0,-1):e}function cleanall(){confirm("确定清空回收站吗")&&(ifroot(),fetch(`${protocol}//${ip}/server/tra/del.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user,token})}).then(e=>{if(e.ok)loadFolder(removeslash(nowpath)),notify("已清空");else throw e.status===401?(selectedarray.length==0,loadFolder(removeslash(nowpath)),notify("无清空权限"),new Error("未授权访问")):(selectedarray.length==0,loadFolder(removeslash(nowpath)),notify(e.status+"错误"),new Error("未授权访问"))}).catch(e=>{console.error("错误:",e)}))}