let uploadpath,nowpath="/",fullPath,editmode=0;function optionbar(e){const t=document.getElementById("option-bar"),n=document.getElementById("openbar");switch(e){case 0:allmove(e),optionstatus=0,n.style.display="block",t.style.left="",setTimeout(()=>{t.style.display="none"},1e3);break;case 1:allmove(e),optionstatus=1,t.style.display="",setTimeout(()=>{n.style.display="none",t.style.left="0"},10);break}}function allmove(e){const t=document.querySelectorAll(".main");switch(e){case 1:t.forEach(function(e){e&&(e.style.marginLeft="")});break;case 0:t.forEach(function(e){e.style.marginLeft="0"});break}}function handleScroll(){var e=window.scrollY||document.documentElement.scrollTop;e>100?(document.getElementById("top-btn").style.bottom="90px",document.querySelector(".backbtn").style.left="1%",document.getElementById("top-bar").style.boxShadow="none",document.getElementById("top-bar").style.top="10px",document.getElementById("top-bar").style.backgroundColor="transparent",document.getElementById("cover-bar").style.top="0",document.getElementById("top-bar").style.backdropFilter=`none`,document.getElementById("top-bar").style.webkitBackdropFilter=`none`):(document.getElementById("top-btn").style.bottom="",document.querySelector(".backbtn").style.left="5%",document.getElementById("top-bar").style.boxShadow="",document.getElementById("top-bar").style.top="77px",document.getElementById("top-bar").style.backgroundColor="",document.getElementById("cover-bar").style.top="",document.getElementById("top-bar").style.backdropFilter=``,document.getElementById("top-bar").style.webkitBackdropFilter=``)}window.addEventListener("scroll",handleScroll);function comin(){theme(mode,"green"),loadFolder(),document.querySelector(".backbtn").style.left="5%",document.getElementById("fileListContainer").style.opacity="1",document.getElementById("option-bar").style.left="0",document.getElementById("option-bar").style.opacity="1",document.getElementById("top-bar").style.top=`77px`}window.onload=comin;function goBack(){window.location.replace(`../../index.html#${ip}`)}function loading(e){const a=document.getElementById("uploadfile"),r=document.getElementById("uploadfolder"),t=document.getElementById("loading"),n=document.getElementById("rotate-box"),c=document.getElementById("load-text"),s=document.getElementById("upButton"),o=document.getElementById("currentPath"),i=document.getElementById("progress");switch(e){case 1:if(a.files.length===0&&r.files.length===0){notify("请先选择一个文件进行上传");return}o.style.display="none",s.style.display="none",i.style.display="block",t.style.display="block",n.style.display="block";break;case 0:o.style.display="",s.style.display="",i.style.display="none",t.style.display="none",n.style.display="none";break}}function pathlen(e,t){const i=e.offsetWidth,n=document.createElement("span");n.style.visibility="hidden",n.style.position="absolute",n.style.font=window.getComputedStyle(e).font,n.innerText="字",document.body.appendChild(n);const a=n.offsetWidth;document.body.removeChild(n);const s=Math.floor(i/a);let o=t;t.length>s&&e.id==="currentPath"?o="..."+t.slice(-s):t.length>s&&(o=t.slice(0,s)+"..."),e.innerText=o}function loadFolder(e=""){pageloading(1),selectedarray.length=0,fetch(`${protocol}//${ip}/server/doc/list.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder:e})}).then(e=>e.json()).then(e=>{const n=document.getElementById("fileList");n.innerHTML="";const s=document.getElementById("currentPath");fullPath=(e.currentFolder?e.currentFolder:"")+"/",pathlen(s,fullPath),s.title=fullPath;const o=e.file_list[0];for(const[t,s]of Object.entries(o)){if(s==="file"||s==="link_file"){const s=document.createElement("li"),a=document.createElement("div");a.className="edit li-btn",a.title=`重命名`,a.addEventListener("click",function(){event.stopPropagation(),rename(0,s,1)});const r=document.createElement("div");r.className="save li-btn",r.addEventListener("click",function(){event.stopPropagation(),rename(1,s)}),s.className="files",s.classList.add("file");const i=document.createElement("span"),c=document.createElement("input");c.classList.add("file-tit");const l=`${protocol}//${ip}/file/Documents/`+(e.currentFolder?e.currentFolder+"/"+t:t),d=document.getElementById("fileListContainer");i.textContent=t,i.className="fileLink",i.title=`预览${t}`,s.addEventListener("click",function(){select(s,1)}),i.addEventListener("click",function(){if(event.stopPropagation(),event.target.isContentEditable)return;let e;nowpath=fullPath;let n=`${protocol}//${ip}/file/Documents/`;nowpath==="/"?e=n+t:e=n+nowpath+t,window.location.href=e}),s.appendChild(c),s.appendChild(i),s.appendChild(a),s.appendChild(r);const o=document.createElement("div");o.className="downloadLink",o.classList.add("down-btn"),o.title=`下载${t}`,o.textContent=`下载 ${t}`,o.addEventListener("click",()=>{event.stopPropagation(),download(e.currentFolder,t,"file")}),s.appendChild(o),n.appendChild(s)}if(s==="folder"||s==="link_dir"){const s=document.createElement("li"),i=document.createElement("div"),a=document.createElement("div");a.classList.add("down-btn"),a.title=`下载${t}`,a.addEventListener("click",function(){event.stopPropagation(),confirm(`确定要下载`+t+"吗?")&&download(e.currentFolder,t,"folder")}),i.className="edit li-btn",i.title=`重命名`,i.addEventListener("click",function(){event.stopPropagation(),rename(0,s,2)});const r=document.createElement("div");r.className="save li-btn",r.addEventListener("click",function(){event.stopPropagation(),rename(1,s)}),s.className="files",s.classList.add("folder");const o=document.createElement("span"),c=document.createElement("input");c.classList.add("file-tit"),o.textContent=t,o.className="folderLink",o.title="进入"+t,s.addEventListener("click",function(){select(s,2)}),o.addEventListener("click",function(){if(event.stopPropagation(),event.target.isContentEditable)return;loadFolder(e.currentFolder?e.currentFolder+"/"+t:t)}),s.appendChild(c),s.appendChild(o),s.appendChild(a),s.appendChild(i),s.appendChild(r),n.appendChild(s)}}pageloading(0);const t=document.getElementById("upButton");e.currentFolder&&e.currentFolder!==""?(t.style.display="block",t.dataset.parentFolder=e.parentFolder,t.style.pointerEvents="auto"):t.style.pointerEvents="none"})}function goUp(){const e=document.getElementById("upButton"),t=e.dataset.parentFolder;loadFolder(t)}function ifroot(){fullPath=="/"?nowpath="":nowpath=fullPath}function keynewfolder(e){e.key==="Enter"&&newfolder(2)}function newfolder(e){const s=document.getElementById("path-bar"),t=document.getElementById("folder-name-bar"),o=document.getElementById("comfirm"),i=document.getElementById("cancel-folder"),a=document.getElementById("upButton"),r=document.getElementById("add-folder");let n=t.value;switch(e){case 1:if(editmode!=0){notify("请保存正在编辑内容");return}editmode=1,s.style.display="none",t.style.display="block",o.style.display="block",i.style.display="block",a.style.display="none",r.style.display="none",document.addEventListener("keydown",keynewfolder);break;case 0:s.style.display="",t.style.display="",o.style.display="",i.style.display="",a.style.display="",r.style.display="",editmode=0,document.removeEventListener("keydown",keynewfolder);break;case 2:ifroot(),pageloading(1),n===""&&(n="new_folder"),fetch(`${protocol}//${ip}/server/doc/new_folder.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folderName:n,nowpath,user,token})}).then(e=>{if(e.status===401)throw notify("无新建文件夹权限"),pageloading(0),new Error("未授权访问");return e.text()}).then(e=>{loadFolder(removeslash(nowpath)),t.value="",editmode=0,document.removeEventListener("keydown",keynewfolder),notify("新建:"+n)}).catch(e=>{console.error("Error:",e)}),newfolder(0);break}}function del(){if(confirm("确定要删除所选文件吗")){ifroot(),pageloading(1);const t=JSON.stringify(selectedarray),e={dellist:t};e.user=user,e.token=token,fetch(`${protocol}//${ip}/server/doc/del.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>{if(e.status===401)throw notify("无删除权限"),pageloading(0),new Error("未授权访问");return e.text()}).then(e=>{loadFolder(removeslash(nowpath)),notify("已删除"),pastebtn.style.display="none",copyarray.length=0}).catch(e=>{console.error("错误:",e)})}}function download(e,t,n){switch(n){case"file":e=e+"/"+t,window.location.href=`${protocol}//${ip}/server/doc/download_file.cgi?file_path=${e}&token=${token}&user=${user}`,notify("开始下载");break;case"folder":e=e+"/"+t;const n=t+".zip";fetch(`${protocol}//${ip}/server/doc/zip_folder.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({folder_path:e,token,user})}).then(e=>{if(e.status===401)throw notify("无下载文件夹权限"),pageloading(0),new Error("未授权访问");return e.text()}).then(()=>{window.location.href=`${protocol}//${ip}/server/doc/down_zip.cgi?file_path=${n}`,notify("开始下载")}).catch(e=>console.error("请求失败:",e));break}}let pastestatus,copyarray=[];const pastebtn=document.getElementById("paste");function copy(e){if(copyarray.length=0,selectedarray.length==0){notify("请选择文件"),pastebtn.style.display="none";return}switch(e){case 1:pastestatus=1;break;case 0:pastestatus=0;break}copyarray=selectedarray.slice(),pastebtn.style.display="block"}let copylist;function paste(){ifroot(),copylist=JSON.stringify(copyarray);const e={copylist,nowpath,user,token};switch(pastestatus){case 1:pageloading(1),fetch(`${protocol}//${ip}/server/doc/copy.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>{if(e.status===401)throw notify("无复制权限"),pageloading(0),new Error("未授权访问");return e.text()}).then(e=>{loadFolder(removeslash(nowpath)),notify("已复制"),pastebtn.style.display="none",copyarray.length=0}).catch(e=>{console.error("错误:",e)});break;case 0:pageloading(1),fetch(`${protocol}//${ip}/server/doc/move.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(e=>{if(e.status===401)throw notify("无移动权限"),pageloading(0),new Error("未授权访问");return e.text()}).then(e=>{loadFolder(removeslash(nowpath)),notify("已移动"),pastebtn.style.display="none",copyarray.length=0,console.log(e)}).catch(e=>{console.error("错误:",e)});break}}let filesname,selectedpath,selectedarray=[],index,selectcount;function select(e,t){switch(t){case 1:filesname=e.querySelector(".fileLink");break;case 2:filesname=e.querySelector(".folderLink");break}selectedpath=fullPath+filesname.innerText,e.classList.contains("selected")?(notify("取消选择"),e.classList.remove("selected"),index=selectedarray.indexOf(selectedpath),selectedarray.splice(index,1)):(selectcount=selectedarray.length+1,notify("已选择"+selectcount+"个文件"),e.classList.add("selected"),selectedarray.push(selectedpath))}let oldname,newname;function rename(e,t,n){let a,r,o;const c=t.querySelector(".edit"),l=t.querySelector(".save"),i=t.querySelector(".file-tit");switch(n){case 1:o=t.querySelector(".fileLink");break;case 2:o=t.querySelector(".folderLink");break}switch(e){case 0:if(editmode!=0){notify("请保存正在编辑内容");return}editmode=1,c.style.display="none",l.style.display="block",o.style.display="none",i.style.display="block",i.contentEditable="true",i.value=o.innerText,o.setAttribute("contenteditable","true"),oldname=o.innerText;break;case 1:ifroot(),newname=i.value,r=nowpath+oldname,a=nowpath+newname,fetch(`${protocol}//${ip}/server/doc/rename.cgi`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user,token,oldpath:r,newpath:a})}).then(e=>{if(e.status===401)throw notify("无重命名权限"),pageloading(0),new Error("未授权访问");return e.text()}).then(e=>{loadFolder(removeslash(nowpath)),editmode=0,notify("修改成功")}).catch(e=>{console.log(e),notify(data)});break}}function removeslash(e){return e.endsWith("/")?e.slice(0,-1):e}function showupload(e){const t=document.getElementById("upload-page");switch(e){case 0:t.style.opacity="0",setTimeout(()=>{t.style.display=""},500);break;case 1:t.style.display="flex",setTimeout(()=>{t.style.opacity="1"},10);break}}function clickable(e){switch(e){case 0:document.body.style.pointerEvents="none";break;case 1:document.body.style.pointerEvents="auto";break}}